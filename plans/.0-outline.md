# Quench Implementation Outline

Phases are numbered by milestone: 0xx (pre-milestone), 1xx (after first checkpoint), etc.
Within each range, phases use increments of 5 (001, 005, 010...) to allow insertions.

---

## Phase 001: Project Foundation - Setup

- [x] Project scaffolding (Cargo.toml workspace, crates/cli, directory structure, dependencies)
- [x] Error types and Result aliases
- [x] Unit test setup (cargo test, yare for concise tests, proptest for property-based testing)
- [x] Integration test harness (CLI invocation via assert_cmd)
- [x] Benchmarking setup (criterion crate)

## Phase 002: Benchmark Fixtures

- [x] fixtures/bench-small/ - 50 files, 5K LOC (baseline)
- [x] fixtures/bench-medium/ - 500 files, 50K LOC (target case)
- [x] fixtures/bench-large/ - 5K files, 500K LOC (stress test)
- [x] fixtures/bench-deep/ - 1K files, 50+ levels deep
- [x] fixtures/bench-large-files/ - 100 files including several >1MB
- [x] Benchmark: file walking only (no checking)
- [x] Benchmark: full check pipeline
- [x] CI benchmark tracking (track regressions in quench's own performance)

## Phase 003: CLI Contract - Specs

- [x] Spec: CLI commands are exactly: (none), help, check, report, init
- [x] Spec: global short flags are exactly: -h, -V, -C
- [x] Spec: check short flags are exactly: -o
- [x] Spec: unrecognized flags produce error (not silently ignored)
- [x] Spec: unrecognized config keys produce warning
- [x] Spec: env vars are exactly: QUENCH_NO_COLOR, QUENCH_CONFIG, QUENCH_LOG

## Phase 005: Project Foundation - Implementation

- [x] CLI skeleton with clap (quench, quench help, quench check, quench report, quench init)
- [x] Global flags (--help, --version, --config)
- [x] File arguments for single-file/directory mode
- [x] Config file discovery (current dir, parent dirs, up to git root)
- [x] Config parsing with serde/toml
- [x] Config version validation (version = 1)
- [x] Unknown key warnings (forward compatibility)
- [x] QUENCH_LOG env var and tracing setup (off, error, warn, info, debug, trace)

## Phase 010: Test Fixtures

- [x] fixtures/minimal/ - bare project, no config, no source files
- [x] fixtures/rust-simple/ - small Rust project with Cargo.toml, src/, tests/
- [x] fixtures/rust-workspace/ - multi-package Rust workspace
- [x] fixtures/shell-scripts/ - shell scripts with bats tests
- [x] fixtures/mixed/ - Rust CLI + shell scripts combination
- [x] fixtures/violations/ - project with intentional violations for each check type
- [x] fixtures/docs-project/ - project with docs/, specs, TOC trees, markdown links
- [x] fixtures/agents-project/ - project with CLAUDE.md, .cursorrules, sections
- [x] Fixture README documenting purpose of each fixture

## Phase 015: File Walking - Specs

- [x] Spec: file walking respects .gitignore
- [x] Spec: file walking respects custom ignore patterns
- [x] Spec: symlink loops don't cause infinite recursion
- [x] Spec: deeply nested directories work (up to depth limit)

## Phase 020: File Walking - Implementation

- [x] Parallel file walking with ignore crate
- [x] Gitignore integration (.gitignore, .ignore, global ignores)
- [x] Custom ignore patterns from config
- [x] Symlink loop detection
- [x] Directory depth limiting (max 100)
- [x] File metadata reading (size, mtime)
- [x] Size-gated file reading (check size before read, skip >10MB with warning)
- [x] Direct read for files <64KB, memory-mapped I/O for 64KB-10MB
- [x] Per-file processing timeout (5s default)
- [x] Unit tests for walker with temp directories
- [x] Benchmark: file walking on bench-medium fixture

## Phase 025: Output Infrastructure - Specs

- [x] Spec: text output format matches docs/specs/03-output.md
- [x] Spec: JSON output validates against output.schema.json
- [x] Spec: JSON output has no additional properties (schema)
- [x] Spec: exit codes are exactly 0 (pass), 1 (fail), 2 (config), 3 (internal)
- [x] Spec: color disabled when CLAUDE_CODE env var set
- [x] Spec: color disabled when not a TTY
- [x] Spec: --no-color flag disables color
- [x] Spec: exit code 0 when all checks pass
- [x] Spec: exit code 1 when any check fails
- [x] Spec: exit code 2 on config error
- [x] Spec: violation limit defaults to 15
- [x] Spec: --no-limit shows all violations
- [x] Spec: --limit N shows N violations
- [x] Spec: --config validates config and exits without running checks
- [x] Spec: QUENCH_LOG=debug emits diagnostics to stderr

## Phase 030: Output Infrastructure - Implementation

- [x] Text output formatter (check: FAIL format)
- [x] JSON output formatter (top-level schema)
- [x] TTY detection for color
- [x] Agent environment detection (CLAUDE_CODE, CODEX, CURSOR)
- [x] Color scheme (bold check names, red FAIL, cyan paths, yellow line numbers)
- [x] --color/--no-color flag handling
- [x] Exit codes (0 pass, 1 fail, 2 config error, 3 internal error)
- [x] Violation limiting (default 15, --limit N, --no-limit)
- [x] Streaming output (default) vs buffered (JSON)
- [x] --config flag (validate and exit)

## Phase 035: Check Framework - Specs

- [x] Spec: check names are exactly: cloc, escapes, agents, docs, tests, git, build, license
- [x] Spec: --cloc flag enables only cloc check
- [x] Spec: --no-cloc flag disables cloc check
- [x] Spec: multiple check flags combine correctly
- [x] Spec: check failure doesn't prevent other checks from running
- [x] Spec: skipped check shows error but continues

## Phase 040: Check Framework - Implementation

- [x] Check trait definition (name, run, fixable)
- [x] Check result type (passed, violations, metrics, by_package)
- [x] Violation type (file, line, type, advice, extra fields)
- [x] Check registry and discovery
- [x] Check runner (parallel execution across checks)
- [x] Check toggle flags (--[no-]cloc, --[no-]escapes, etc.)
- [x] Per-package metrics aggregation infrastructure
- [x] Error recovery (continue on check failure, skip on error)
- [x] Early termination when violation limit reached (non-CI mode)
- [x] Unit tests for check runner with mock checks

### Checkpoint: CLI Runs
- [x] `quench check` on fixtures/minimal runs without panic
- [x] `quench check --help` shows all flags
- [x] `quench check -o json` produces valid JSON structure
- [x] Exit code 0 when no checks enabled

## Phase 045: Performance - Caching (P0)

File-level caching is P0 per the performance spec: it directly serves the primary use case
of agents iterating on fixes. Most runs are re-runs where few files changed.

- [x] File cache structure (path -> mtime, size, result)
- [x] Cache lookup before file processing
- [x] Cache population after processing
- [x] In-memory cache for single session
- [x] Persistent cache (.quench/cache.bin)
- [x] Cache invalidation (config change, version change)
- [x] --no-cache flag to bypass cache
- [x] Benchmark: warm run on bench-medium (target <100ms)

---

## Phase 101: CLOC Check - Specs

- [x] Spec: counts non-blank lines as LOC
- [x] Spec: blank lines not counted
- [x] Spec: separates source and test files by pattern
- [x] Spec: calculates source-to-test ratio
- [x] Spec: JSON output includes source_lines, test_lines, ratio
- [x] Spec: cloc violation.type is always "file_too_large"
- [x] Spec: files over max_lines (750) generate violation
- [x] Spec: test files over max_lines_test (1000) generate violation
- [x] Spec: files over max_tokens generate violation
- [x] Spec: excluded patterns don't generate violations
- [x] Spec: per-package breakdown in JSON when packages configured

## Phase 105: CLOC Check - Basic Implementation

- [x] Line counting (non-whitespace lines)
- [x] Source pattern matching from config
- [x] Test pattern matching from config
- [x] Source vs test file classification
- [x] Total source/test line metrics
- [x] Source-to-test ratio calculation
- [x] Unit tests for line counting edge cases

## Phase 110: CLOC Check - Limits Implementation

- [x] File size limit checking (max_lines, default 750)
- [x] Test file size limit checking (max_lines_test, default 1000)
- [x] Token counting (chars / 4 approximation)
- [x] Token limit checking (max_tokens, default 20000)
- [x] Per-file violation generation for oversized files
- [x] Exclude patterns for size limits
- [x] Per-package LOC breakdown
- [x] JSON output with metrics and by_package

### Checkpoint: CLOC Works
- [x] `quench check --cloc` on fixtures/rust-simple produces correct line counts
- [x] `quench check --cloc` on fixtures/violations detects oversized file
- [x] Snapshot test for CLOC text output
- [x] Snapshot test for CLOC JSON output

---

## Phase 201: Generic Language Adapter

- [x] Adapter trait definition
- [x] Pattern-based source detection from [project] config
- [x] Pattern-based test detection from [project] config
- [x] Language-agnostic escape patterns (none by default)
- [x] Adapter selection based on file extension
- [x] Unit tests for pattern matching

## Phase 205: Escapes Check - Specs

- [x] Spec: detects pattern matches in source files
- [x] Spec: reports line number of match
- [x] Spec: count action counts occurrences
- [x] Spec: count action fails when threshold exceeded
- [x] Spec: comment action passes when comment present on same line
- [x] Spec: comment action passes when comment present on preceding line
- [x] Spec: comment action fails when no comment found
- [x] Spec: forbid action always fails in source code
- [x] Spec: forbid action allowed in test code
- [x] Spec: test code escapes counted separately in metrics
- [x] Spec: per-pattern advice shown in violation
- [x] Spec: JSON includes source/test breakdown per pattern
- [x] Spec: escapes violation.type is one of: missing_comment, forbidden, threshold_exceeded

## Phase 210: Escapes Check - Pattern Matching

- [x] Pattern configuration parsing ([[check.escapes.patterns]])
- [x] Regex pattern compilation
- [x] Literal pattern detection and memchr optimization
- [x] Multi-literal pattern detection and aho-corasick optimization
- [x] Pattern matching across file contents
- [x] Line number extraction for matches
- [x] Unit tests for each pattern type

## Phase 215: Escapes Check - Actions

- [x] Count action implementation
- [x] Count threshold checking (default 0)
- [x] Comment action implementation
- [x] Upward comment search (same line, preceding lines)
- [x] Custom comment pattern matching (// SAFETY:, etc.)
- [x] Forbid action implementation
- [x] Source vs test code separation for actions
- [x] Unit tests for comment search algorithm

## Phase 220: Escapes Check - Output

- [x] Missing comment violation generation
- [x] Forbidden pattern violation generation
- [x] Threshold exceeded violation generation
- [x] Per-pattern configurable advice
- [x] Per-package escape counts (source/test breakdown)
- [x] JSON output with metrics and by_package
- [x] Early termination when limit reached (non-CI)

### Checkpoint: Escapes Works
- [x] `quench check --escapes` on fixtures/violations detects all escape types
- [x] Snapshot test for escapes text output (missing comment, forbidden, threshold)
- [x] Snapshot test for escapes JSON output

---

## Phase 301: Rust Adapter - Specs

- [x] Spec: auto-detected when Cargo.toml present
- [x] Spec: default source pattern **/*.rs
- [x] Spec: default ignores target/
- [x] Spec: detects workspace packages from Cargo.toml
- [x] Spec: #[cfg(test)] blocks counted as test LOC
- [x] Spec: unsafe without // SAFETY: comment fails
- [x] Spec: .unwrap() in source code fails (forbid)
- [x] Spec: .unwrap() in test code allowed
- [x] Spec: #[allow(...)] without comment fails (when configured)
- [x] Spec: lint config changes with source changes fails standalone policy

## Phase 305: Rust Adapter - Detection

- [x] Cargo.toml detection
- [x] Default source patterns (**/*.rs)
- [x] Default test patterns (tests/**, *_test.rs, *_tests.rs)
- [x] Default ignore patterns (target/)
- [x] Workspace detection and package enumeration
- [x] Integration test: detect packages in fixtures/rust-workspace

## Phase 310: Rust Adapter - Test Code

- [x] #[cfg(test)] block parsing
- [x] Inline test LOC separation (cfg_test_split option)
- [x] Test module detection within source files
- [x] Integration with CLOC check for accurate counts
- [x] Unit tests for #[cfg(test)] parsing edge cases

## Phase 315: Rust Adapter - Escapes

- [x] Default unsafe pattern (unsafe { })
- [x] Default unwrap pattern (.unwrap())
- [x] Default expect pattern (.expect()
- [x] Default transmute pattern (mem::transmute)
- [x] SAFETY comment requirement for unsafe

## Phase 320: Rust Adapter - Suppress

- [x] #[allow(...)] detection
- [x] #[expect(...)] detection
- [x] Suppress check levels (forbid/comment/allow)
- [x] Custom comment pattern for suppress (// JUSTIFIED:)
- [x] Per-code allow list (no comment needed)
- [x] Per-code forbid list (never allowed)
- [x] Separate source vs test suppress policies

## Phase 325: Rust Adapter - Policy

- [x] lint_changes = "standalone" enforcement
- [x] Lint config file detection (rustfmt.toml, clippy.toml)
- [x] Mixed change detection (lint config + source in same branch)
- [x] Standalone PR requirement violation
- [x] Rust profile defaults struct (escapes, suppress, policy for quench init)
- [x] Rust Landing the Plane checklist items (fmt, clippy, test, build)

### Checkpoint: Rust Adapter Complete
- [x] `quench check` on fixtures/rust-simple with no config produces useful output
- [x] `quench check` on fixtures/rust-workspace detects all packages
- [x] Rust-specific escapes detected in fixtures/violations
- [x] #[cfg(test)] LOC counted separately

---

## Phase 401: Shell Adapter - Specs

- [x] Spec: auto-detected when *.sh files in root, bin/, or scripts/
- [x] Spec: default source pattern **/*.sh, **/*.bash
- [x] Spec: default test pattern tests/**/*.bats
- [x] Spec: set +e without # OK: comment fails
- [x] Spec: eval without # OK: comment fails
- [x] Spec: # shellcheck disable= forbidden by default

## Phase 405: Shell Adapter - Detection

- [x] Shell file detection (*.sh in root, bin/, scripts/)
- [x] Default source patterns (**/*.sh, **/*.bash)
- [x] Default test patterns (tests/**/*.bats, *_test.sh)

## Phase 410: Shell Adapter - Escapes

- [x] Default set +e pattern
- [x] Default eval pattern
- [x] OK comment requirement

## Phase 415: Shell Adapter - Suppress

- [x] # shellcheck disable= detection
- [x] Suppress check levels (forbid default for shell)
- [x] Per-code allow/forbid lists
- [x] Separate source vs test policies

## Phase 420: Shell Adapter - Policy

- [x] lint_changes = "standalone" for shell
- [x] .shellcheckrc detection
- [x] Shell profile defaults struct (escapes, suppress, policy for quench init)
- [x] Shell Landing the Plane checklist items (shellcheck, bats)

### Checkpoint: Shell Adapter Complete
- [x] `quench check` on fixtures/shell-scripts produces useful output
- [x] Shell-specific escapes detected in fixtures/violations

---

## Phase 501: Agents Check - Specs

- [x] Spec: detects CLAUDE.md at project root
- [x] Spec: detects .cursorrules at project root
- [x] Spec: missing required file generates violation
- [x] Spec: files out of sync generates violation
- [x] Spec: --fix syncs files from sync_source
- [x] Spec: missing required section generates violation with advice
- [x] Spec: forbidden section generates violation
- [x] Spec: markdown table generates violation (default forbid)
- [x] Spec: file over max_lines generates violation
- [x] Spec: file over max_tokens generates violation
- [x] Spec: JSON includes files_found, in_sync metrics
- [x] Spec: agents violation.type is one of: missing_file, out_of_sync, missing_section, forbidden_section, forbidden_table, file_too_large

## Phase 505: Agents Check - File Detection

- [x] Agent file recognition (CLAUDE.md, AGENTS.md, .cursorrules, .cursor/rules/*.md)
- [x] Configurable files list
- [x] File existence checking
- [x] Required/optional/forbid file configuration
- [x] Scope detection (root vs package vs module)

## Phase 510: Agents Check - Sync

- [x] Multi-file sync detection
- [x] Section-level diff comparison
- [x] sync_source configuration
- [x] Sync violation generation
- [x] --fix: sync from source file

## Phase 515: Agents Check - Sections

- [x] Markdown heading parsing
- [x] Required section validation (case-insensitive)
- [x] Section advice configuration (extended form)
- [x] Forbidden section validation
- [x] Glob pattern matching for forbidden sections
- [x] Claude profile defaults (required: "Directory Structure", "Landing the Plane")
- [x] Cursor profile defaults (required: "Directory Structure", "Landing the Plane")
- [x] Landing the Plane template structure (base + language-specific items)

## Phase 520: Agents Check - Content

- [x] Markdown table detection
- [x] tables = forbid enforcement (default)
- [x] Box diagram detection (┌─┐ style)
- [x] Mermaid block detection
- [x] Size limits (max_lines, max_tokens per scope)

## Phase 525: Agents Check - Output

- [x] Missing file violations
- [x] Out of sync violations
- [x] Missing section violations (with advice)
- [x] Forbidden content violations
- [x] File too large violations
- [x] JSON output with metrics
- [x] --fix output (FIXED status)

### Checkpoint: Agents Check Complete
- [x] `quench check --agents` on fixtures/agents-project detects all violation types
- [x] `quench check --agents --fix` syncs files correctly
- [x] Exact output tests for agents output

## Phase 527: Dry-Run Mode - Specs

- [x] Spec: --dry-run without --fix is an error
- [x] Spec: --dry-run shows files that would be modified
- [x] Spec: --dry-run shows diff of changes
- [x] Spec: --dry-run exits 0 even when fixes needed
- [x] Spec: --dry-run does not modify any files

## Phase 528: Dry-Run Mode - Implementation

- [x] --dry-run flag parsing (requires --fix)
- [x] Fix preview collection (file path, before/after content)
- [x] Diff output formatting
- [x] Suppress actual file writes when --dry-run

### Dogfooding Milestone 1
- [x] Run `quench check` on quench itself (cloc, escapes, agents)
- [x] Fix any violations found
- [x] Add quench.toml to quench project

---

## Phase 601: Docs Check - Specs

- [x] Retire bootstrap file size check (replaced by cloc)
- [x] Retire bootstrap dead code check (replaced by escapes)
- [x] Spec: TOC tree entries validated against filesystem
- [x] Spec: broken TOC path generates violation
- [x] Spec: markdown link to missing file generates violation
- [x] Spec: external URLs not validated
- [x] Spec: specs directory index file detected
- [x] Spec: unreachable spec file generates violation (linked mode)
- [x] Spec: missing required section in spec generates violation
- [x] Spec: feature commit without doc change generates violation (CI mode)
- [x] Spec: area mapping restricts doc requirement to specific paths
- [x] Spec: docs violation.type is one of: missing_section, forbidden_section, broken_toc, broken_link, missing_docs

## Phase 605: Docs Check - TOC Validation

- [x] Fenced code block detection in markdown
- [x] Directory tree structure parsing
- [x] Tree entry extraction (files and directories)
- [x] Comment stripping (after #)
- [x] Path resolution (relative to file, docs/, root)
- [x] File existence validation
- [x] Exclude patterns (plans/**, plan.md, etc.)
- [x] Broken TOC violation generation
- [x] Unit tests for tree parsing

## Phase 610: Docs Check - Link Validation

- [x] Markdown link parsing ([text](path))
- [x] Local file link detection (vs http/https)
- [x] Relative path resolution
- [x] File existence validation
- [x] Exclude patterns
- [x] Broken link violation generation

## Phase 615: Docs Check - Specs Directory

- [x] Specs path configuration (default: docs/specs)
- [x] Extension filtering (.md default)
- [x] Index file detection order (CLAUDE.md, overview.md, etc.)
- [x] index = "exists" mode (just check index exists)

## Phase 620: Docs Check - Specs Index Modes

- [x] index = "toc" mode (parse directory tree in index)
- [x] index = "linked" mode (reachability via markdown links)
- [x] index = "auto" mode (try toc, fallback to linked)
- [x] Unreachable spec violation generation

## Phase 625: Docs Check - Specs Content

- [x] Required sections in spec files
- [x] Forbidden sections in spec files
- [x] Content rules (tables, diagrams allowed by default)
- [x] Size limits for spec files

## Phase 630: Docs Check - Commit Checking (CI)

- [x] check.docs.commit configuration
- [x] Commit type filtering (feat, breaking, etc.)
- [x] Branch commit enumeration (vs base)
- [x] Feature commit identification
- [x] Doc change detection (any file in docs/)

## Phase 635: Docs Check - Area Mapping

- [x] Area definition ([check.docs.area.*])
- [x] Area docs path configuration
- [x] Area source path configuration
- [x] Commit scope to area matching (feat(api) -> api area)
- [x] Source change to area matching
- [x] Area-specific doc requirement violations

### Checkpoint: Docs Check Complete
- [x] `quench check --docs` on fixtures/docs-project validates TOC and links
- [x] `quench check --docs` on quench itself validates docs/specs/
- [x] Exact output tests for docs output

---

## Phase 701: Tests Check - Specs (Correlation)

- [x] Spec: --staged checks only staged files
- [x] Spec: --base REF compares against git ref
- [x] Spec: source change without test change generates violation
- [x] Spec: test change without source change passes (TDD)
- [x] Spec: inline #[cfg(test)] change satisfies test requirement
- [x] Spec: placeholder test (#[ignore]) satisfies test requirement
- [x] Spec: excluded files (mod.rs, main.rs) don't require tests
- [x] Spec: JSON includes source_files_changed, with_test_changes metrics
- [x] Spec: tests violation.type is always "missing_tests"

## Phase 705: Tests Check - Change Detection

- [x] Git diff parsing (--staged, --base)
- [x] Source file change detection
- [x] Added/modified/deleted classification
- [x] Lines changed counting
- [x] Test pattern matching

## Phase 710: Tests Check - Correlation

- [x] Test file matching for source files
- [x] Multiple test location search (tests/, *_test.rs, etc.)
- [x] Inline test change detection (Rust #[cfg(test)])
- [x] Branch scope: aggregate all changes
- [x] Commit scope: per-commit with asymmetric rules (tests-first OK)

## Phase 715: Tests Check - Placeholders

- [x] Rust #[ignore] test detection
- [x] Rust todo!() body detection
- [x] JavaScript test.todo() detection
- [x] JavaScript test.fixme() detection
- [x] placeholders = "allow" configuration

## Phase 720: Tests Check - Output

- [x] Missing tests violation generation
- [x] change_type in violations (added/modified)
- [x] lines_changed in violations
- [x] Exclude patterns (mod.rs, main.rs, generated/)
- [x] JSON output with metrics

### Checkpoint: Tests Correlation Complete
- [x] `quench check --staged` works in fixtures with staged changes
- [x] `quench check --base main` works in fixtures with branch changes
- [x] Exact output tests for tests correlation output

---

## Phase 801: Git Check - Specs

- [x] Spec: validates commit message format
- [x] Spec: invalid type generates violation
- [x] Spec: invalid scope generates violation (when scopes configured)
- [x] Spec: missing format documentation in CLAUDE.md generates violation
- [x] Spec: --fix creates .gitmessage template
- [x] Spec: --fix configures git commit.template
- [x] Spec: git violation.type is one of: invalid_format, invalid_type, invalid_scope, missing_docs

## Phase 805: Git Check - Message Parsing

- [x] Commit message extraction (git log)
- [x] Conventional commit regex parsing
- [x] Type extraction
- [x] Scope extraction (optional)
- [x] Description extraction
- [x] Unit tests for commit message parsing

## Phase 810: Git Check - Validation

- [x] Format validation (type: or type(scope):)
- [x] Type validation against allowed list
- [x] Scope validation against allowed list (if configured)
- [x] Invalid format violation generation
- [x] Invalid type violation generation
- [x] Invalid scope violation generation

## Phase 815: Git Check - Agent Documentation

- [x] CLAUDE.md commit format section search
- [x] Type prefix detection in docs (feat:, fix()
- [x] "conventional commits" phrase detection
- [x] Missing documentation violation

## Phase 820: Git Check - Template

- [x] .gitmessage template generation
- [x] Template content from config (types, scopes)
- [x] git config commit.template setting
- [x] --fix: create template if missing
- [x] --fix: configure git if not set

### Checkpoint: Git Check Complete
- [x] `quench check --git` validates commit messages
- [x] `quench check --git --fix` creates .gitmessage template
- [x] Exact output tests for git output

### Dogfooding Milestone 2
- [x] `quench check --staged` runs on every commit
- [x] All fast checks pass on quench codebase

---

## Phase 901: CI Mode - Specs

- [x] Spec: --ci enables slow checks (build, license)
- [x] Spec: --ci disables violation display limit
- [x] Spec: --ci auto-detects base branch
- [x] Spec: --save FILE writes metrics to file
- [x] Spec: --save-notes writes metrics to git notes

## Phase 905: CI Mode Infrastructure

- [x] --ci flag handling
- [x] Base branch auto-detection (main > master > develop)
- [x] Slow check enabling (build, license)
- [x] Full violation counting (no limit)
- [x] Metrics storage path configuration
- [x] --save FILE flag
- [x] --save-notes flag (git notes)
- [ ] Benchmark regression tracking (compare against baseline, fail CI if >20% slower)

## Phase 910: Test Runners - Specs

- [x] Spec: cargo runner executes cargo test
- [ ] Spec: cargo runner extracts per-test timing (blocked: Cargo JSON format)
- [x] Spec: bats runner executes bats with timing
- [ ] Spec: coverage collected for Rust code
- [ ] Spec: coverage collected for shell scripts via kcov
- [ ] Spec: multiple suite coverages merged

## Phase 915: Test Runners - Framework

- [x] Runner trait definition
- [x] Suite configuration parsing ([[check.tests.suite]])
- [x] Runner selection by name
- [x] Setup command execution
- [x] ci = true filtering (CI-only suites)

## Phase 920: Test Runners - Cargo

- [x] cargo test --release -- --format json execution
- [x] JSON output parsing
- [ ] Per-test timing extraction (blocked: Cargo JSON format)
- [x] Pass/fail status extraction
- [x] Test count metrics
- [x] Integration test: run cargo tests on fixtures/rust-simple

## Phase 925: Test Runners - Cargo Coverage

- [x] cargo llvm-cov integration
- [x] Coverage report parsing
- [x] Line coverage percentage extraction
- [x] Per-file coverage data

## Phase 930: Test Runners - Bats

- [x] bats --timing execution
- [x] TAP output parsing
- [x] Per-test timing extraction
- [x] Pass/fail status extraction
- [x] Integration test: run bats tests on fixtures/shell-scripts

## Phase 935: Test Runners - Other Runners

- [x] pytest runner (--durations=0 -v)
- [x] vitest runner (--reporter=json)
- [x] jest runner (--json)
- [x] bun runner (--reporter=json)
- [x] go test runner (-json)
- [x] Custom command runner (no per-test timing)

## Phase 940: Test Runners - Coverage Targets

- [x] targets field parsing
- [x] Build target name resolution (Rust binaries)
- [x] Glob pattern resolution (shell scripts)
- [x] Instrumented binary building
- [x] kcov integration for shell scripts
- [ ] Coverage merging across suites

## Phase 945: Tests Check - CI Mode Metrics

- [x] Test suite execution orchestration
- [x] Total time aggregation
- [x] Average time calculation
- [x] Max test time tracking (with test name)
- [ ] Coverage aggregation by language
- [ ] Per-package coverage breakdown

## Phase 950: Tests Check CI Thresholds - Specs

- [ ] Spec: coverage below min generates violation
- [ ] Spec: per-package coverage thresholds work
- [ ] Spec: test time over max_total generates violation
- [ ] Spec: slowest test over max_test generates violation
- [ ] Spec: tests CI violation.type is one of: coverage_below_min, time_total_exceeded, time_test_exceeded

## Phase 955: Tests Check - CI Mode Thresholds

- [ ] coverage.min threshold checking
- [ ] Per-package coverage.min
- [ ] time.max_total threshold (per suite)
- [ ] time.max_avg threshold (per suite)
- [ ] time.max_test threshold (per suite)
- [ ] check.tests.time check level (error/warn/off)
- [ ] check.tests.coverage check level

### Checkpoint: Tests CI Mode Complete
- [ ] `quench check --ci --tests` runs tests and collects coverage
- [x] Coverage and timing metrics in JSON output
- [ ] Exact output tests for CI tests output

---

## Phase 1001: Build Check - Specs

- [x] Spec: detects binary targets from Cargo.toml
- [x] Spec: measures binary size
- [x] Spec: binary over size_max generates violation
- [x] Spec: measures cold build time
- [x] Spec: measures hot build time
- [x] Spec: build time over threshold generates violation
- [x] Spec: build violation.type is one of: size_exceeded, time_cold_exceeded, time_hot_exceeded, missing_target

## Phase 1005: Build Check - Targets

- [x] Build target detection from language adapters
- [x] Rust: [[bin]] entries from Cargo.toml
- [x] Explicit targets configuration override
- [x] Per-target configuration ([check.build.target.*])

## Phase 1010: Build Check - Size

- [x] Release build execution
- [x] Binary file size measurement
- [x] Strip handling (respect profile.release.strip)
- [x] size_max threshold checking (global and per-target)
- [x] Size violation generation

## Phase 1015: Build Check - Time

- [x] Cold build execution (cargo clean && cargo build --release)
- [x] Cold build timing
- [x] Hot build execution (touch && cargo build)
- [x] Hot build timing
- [x] time_cold_max threshold checking
- [x] time_hot_max threshold checking
- [x] Time violation generation

## Phase 1020: Build Check - Output

- [x] Build metrics output (size, time)
- [x] JSON output with metrics
- [x] Per-target breakdown

### Checkpoint: Build Check Complete
- [x] `quench check --ci --build` measures binary size and build time
- [x] Exact output tests for build output

---

## Phase 1101: License Check - Specs

- [x] Spec: detects SPDX-License-Identifier header
- [x] Spec: missing header generates violation
- [x] Spec: wrong license generates violation
- [x] Spec: outdated year generates violation
- [x] Spec: --fix adds missing headers
- [x] Spec: --fix updates outdated years
- [x] Spec: shebang preserved when adding header
- [x] Spec: license violation.type is one of: missing_header, outdated_year, wrong_license

## Phase 1105: License Check - Detection

- [ ] SPDX-License-Identifier line detection
- [ ] Copyright line detection
- [ ] License identifier extraction
- [ ] Copyright year extraction
- [ ] Copyright holder extraction

## Phase 1110: License Check - Validation

- [ ] Missing header detection
- [ ] Wrong license detection (vs configured)
- [ ] Outdated year detection (vs current year)
- [ ] File pattern filtering by language
- [ ] Exclude patterns

## Phase 1115: License Check - Comment Syntax

- [ ] Extension to comment style mapping
- [ ] // style (rs, ts, js, go, c, cpp, h)
- [ ] # style (sh, bash, py, rb, yaml)
- [ ] <!-- --> style (html, xml)
- [ ] Custom syntax configuration override

## Phase 1120: License Check - Fix

- [ ] Header generation from config (license, copyright)
- [ ] Header insertion at file start
- [ ] Shebang preservation (insert after #!)
- [ ] Year update in existing headers
- [ ] --fix output (added/updated counts)

### Checkpoint: License Check Complete
- [ ] `quench check --ci --license` detects missing/wrong headers
- [ ] `quench check --ci --license --fix` adds headers correctly
- [ ] Exact output tests for license output

### Dogfooding Milestone 3
- [ ] Full `quench check --ci` runs on quench itself
- [ ] All CI checks pass
- [ ] Coverage metrics collected for quench

---

## Phase 1201: Ratcheting - Specs

- [ ] Delete scripts/bootstrap (fully replaced by quench)
- [ ] Spec: baseline file read on check
- [ ] Spec: coverage below baseline generates violation
- [ ] Spec: escape count above baseline generates violation
- [ ] Spec: tolerance allows small regressions
- [ ] Spec: --fix updates baseline when metrics improve
- [ ] Spec: baseline not updated when metrics regress
- [ ] Spec: per-package ratcheting works
- [ ] Spec: ratchet violation.type is one of: coverage_regression, escapes_regression, size_regression, time_regression

## Phase 1205: Ratcheting - Baseline

- [ ] Baseline file path configuration ([git].baseline)
- [ ] Baseline file reading
- [ ] Baseline file format (version, updated, commit, metrics)
- [ ] Baseline writing on --fix
- [ ] Git notes reading (alternative storage)
- [ ] Git notes writing (--save-notes)

## Phase 1210: Ratcheting - Coverage

- [ ] Coverage floor tracking
- [ ] Coverage regression detection
- [ ] coverage_tolerance configuration
- [ ] Coverage improvement detection
- [ ] Floor update on improvement

## Phase 1215: Ratcheting - Escapes

- [ ] Per-pattern count ceiling tracking
- [ ] Escape count regression detection
- [ ] Escape improvement detection
- [ ] Ceiling update on improvement

## Phase 1220: Ratcheting - Build Metrics

- [ ] binary_size ceiling tracking (opt-in)
- [ ] build_time_cold ceiling tracking (opt-in)
- [ ] build_time_hot ceiling tracking (opt-in)
- [ ] Size/time tolerance configuration
- [ ] Regression detection and violation

## Phase 1225: Ratcheting - Test Time

- [ ] test_time_total ceiling tracking (opt-in)
- [ ] test_time_avg ceiling tracking (opt-in)
- [ ] test_time_max ceiling tracking (opt-in)

## Phase 1230: Ratcheting - Per-Package

- [ ] Per-package baseline storage
- [ ] Per-package ratchet configuration
- [ ] Package-level regression detection
- [ ] Package exclusion from ratcheting

## Phase 1235: Ratcheting - Output

- [ ] Ratchet pass output (current vs baseline)
- [ ] Ratchet fail output (regression details)
- [ ] JSON ratchet section
- [ ] --fix baseline update output

### Checkpoint: Ratcheting Complete
- [ ] Baseline file created with `quench check --ci --fix --save .quench/baseline.json`
- [ ] Regression detected when metrics worsen
- [ ] Baseline updates when metrics improve
- [ ] Exact output tests for ratchet output

---

## Phase 1301: Report Command - Specs

- [x] Spec: quench report reads baseline file
- [x] Spec: text format shows summary
- [x] Spec: JSON format outputs metrics
- [x] Spec: HTML format produces valid HTML
- [x] Spec: -o report.html writes to file

## Phase 1305: Report Command - Basic

- [x] quench report command
- [x] Baseline file reading
- [x] Check toggle flags (same as check)
- [x] Text format output (default)

## Phase 1310: Report Command - Formats

- [x] JSON format output (-o json)
- [x] HTML format output (-o html)
- [x] File output (-o report.html)
- [x] Metric cards and summary tables

### Checkpoint: Report Command Complete
- [x] `quench report` produces readable summary
- [x] `quench report -o json` produces valid JSON
- [x] `quench report -o html` produces valid HTML

---

## Phase 1398: Timing Mode - Specs

- [x] Spec: --timing shows phase breakdown (discovery, reading, checking, output)
- [x] Spec: --timing shows per-check timing
- [x] Spec: --timing works with -o json (adds timing field)
- [x] Spec: --timing shows file count and cache hit rate

## Phase 1399: Timing Mode - Implementation

- [x] --timing flag parsing
- [x] Phase timing instrumentation (start/end markers)
- [x] Per-check timing collection
- [x] Cache statistics (hits, misses, hit rate)
- [x] Timing output formatter (text and JSON)

## Phase 1401: Performance - Optimization Backlog

Apply P1+ optimizations from the performance spec only when profiling justifies them.
Core performance (caching, size-gated reading, timeouts) was implemented in Phases 020/045.

- [ ] Profile on real-world large repos to identify bottlenecks
- [ ] P1: File walking optimizations if >50% time in discovery
- [ ] P2: Pattern matching optimizations if >50% time in matching (Aho-Corasick combining)
- [ ] P3: Memory optimizations if constrained (bounded cache with moka, batch processing)
- [ ] P4: Micro-optimizations only if profiling shows specific bottleneck

### Checkpoint: Performance Complete
- [ ] Benchmark: cold run < 500ms on bench-medium (50K LOC)
- [ ] Benchmark: warm run < 100ms on bench-medium (50K LOC)
- [ ] Large file (>10MB) skipped with warning
- [ ] Cache invalidation works correctly
- [ ] No P1+ optimizations applied without profiling justification

---

## Phase 1501: Init Command - Specs

- [x] Spec: creates quench.toml in current directory
- [x] Spec: refuses to overwrite without --force
- [x] Spec: --force overwrites existing config
- [x] Spec: --with rust configures Rust defaults
- [x] Spec: --with shell configures Shell defaults
- [x] Spec: --with claude configures CLAUDE.md defaults
- [x] Spec: --with cursor configures .cursorrules defaults
- [x] Spec: --with rust,claude combines profiles
- [x] Spec: no --with auto-detects from project root
- [x] Spec: auto-detects Rust when Cargo.toml present
- [x] Spec: auto-detects Shell when *.sh in root/bin/scripts
- [x] Spec: auto-detects Claude when CLAUDE.md exists
- [x] Spec: auto-detects Cursor when .cursorrules exists
- [x] Spec: profile names are exactly: rust, shell, golang, javascript, claude, cursor

## Phase 1505: Init Command - Profile Detection

- [x] quench init command skeleton
- [x] --force flag to overwrite existing
- [x] --with flag parsing (comma-separated list)
- [x] Profile enum (rust, shell, golang, javascript, claude, cursor)
- [x] Language auto-detection (Cargo.toml → rust, *.sh → shell, go.mod → golang, package.json → javascript)
- [x] Agent file auto-detection (CLAUDE.md → claude, .cursorrules → cursor)
- [x] Combined profile resolution (explicit + auto-detected)

## Phase 1510: Init Command - Config Generation

- [x] Profile defaults registry (collect from adapters)
- [x] Rust profile defaults application
- [x] Shell profile defaults application
- [x] Claude profile defaults application
- [x] Cursor profile defaults application
- [x] Profile merging for multi-profile configs
- [x] quench.toml generation and writing

## Phase 1515: Init Command - Landing the Plane

- [x] Landing the Plane section detection in agent files
- [x] Base checklist template (always includes `quench check`)
- [x] Language-specific checklist items from profiles
- [x] Checklist merging (base + rust items + shell items)
- [ ] Agent file updating (append section if missing)
- [ ] Preserve existing Landing the Plane if present

### Checkpoint: Init Command Complete
- [x] `quench init` on fixtures/rust-simple auto-detects rust profile
- [x] `quench init` on fixtures/shell-scripts auto-detects shell profile
- [x] `quench init` on fixtures/mixed auto-detects both languages
- [x] `quench init --with rust` creates Rust-specific config
- [ ] `quench init --with claude` creates CLAUDE.md with required sections
- [ ] `quench init --with rust,claude` populates Landing the Plane with Rust items
- [x] Landing the Plane always includes `quench check` first

---

## Phase 1601: Polish

_Completed incrementally throughout development._

- [x] Comprehensive --help text
- [x] Error message improvements
- [x] Config validation error formatting
- [ ] Shell completions (bash, zsh, fish) - deferred

### Final Validation

- [ ] All Exact output tests pass
- [ ] All integration tests pass
- [ ] `quench check` on quench itself passes
- [ ] `quench check --ci` on quench itself passes with metrics
- [ ] Pre-commit hook works reliably
- [ ] JSON output validates against output.schema.json
- [ ] Performance targets met (< 500ms cold, < 100ms warm)
