# Ruby Language Adapter Roadmap

This roadmap covers adding Ruby language support to quench.
Phases use 48x numbering (after Go 45x-47x, before JavaScript 49x).

## Dependencies from .0-outline

| This Phase | Blocked By | Reason |
|------------|------------|--------|
| 481 | Phase 201 | Requires adapter trait definition |
| 483 | Phase 201 | Requires adapter trait definition |
| 485 | Phase 205-220 | Requires escapes check framework |
| 486 | Phase 205-220 | Requires escapes check framework |
| 487 | Phase 705-720 | Requires tests check correlation |
| 488 | Phase 915 | Requires test runner framework |
| 489 | Phase 1505-1510 | Requires init command profile system |

---

## Phase 481: Ruby Adapter - Specs

_Blocked by: Phase 201 (Generic Language Adapter)_

- [ ] Spec: auto-detected when Gemfile, *.gemspec, config.ru, or config/application.rb present
- [ ] Spec: default source pattern **/*.rb, **/*.rake
- [ ] Spec: default test patterns spec/**/*_spec.rb, test/**/*_test.rb, features/**/*.rb
- [ ] Spec: default ignores vendor/, tmp/, log/, coverage/
- [ ] Spec: detects gem name from *.gemspec
- [ ] Spec: `eval(` without # METAPROGRAMMING: comment fails
- [ ] Spec: `instance_eval` without # METAPROGRAMMING: comment fails
- [ ] Spec: `class_eval` without # METAPROGRAMMING: comment fails
- [ ] Spec: `binding.pry` forbidden in source code
- [ ] Spec: `byebug` forbidden in source code
- [ ] Spec: `debugger` forbidden in source code
- [ ] Spec: # rubocop:disable without comment fails (when configured)
- [ ] Spec: lint config changes with source changes fails standalone policy

## Phase 483: Ruby Adapter - Detection

_Blocked by: Phase 201 (Generic Language Adapter)_

- [ ] Gemfile detection
- [ ] *.gemspec detection
- [ ] config.ru detection (Rack apps)
- [ ] config/application.rb detection (Rails apps)
- [ ] Default source patterns (**/*.rb, **/*.rake, Rakefile, Gemfile)
- [ ] Default test patterns (spec/**/*_spec.rb, test/**/*_test.rb, features/**/*.rb)
- [ ] Default ignore patterns (vendor/, tmp/, log/, coverage/)
- [ ] Gem name extraction from *.gemspec
- [ ] Integration test: detect gem name in fixtures/ruby-gem

## Phase 484: Ruby Test Fixture

_Blocked by: Phase 010 (Test Fixtures) - can run in parallel_

- [ ] fixtures/ruby-gem/ - small Ruby gem with *.gemspec, lib/, spec/
- [ ] fixtures/ruby-rails/ - Rails app with config/application.rb
- [ ] Add Ruby violations to fixtures/violations/
- [ ] Fixture README updates

## Phase 485: Ruby Adapter - Escapes

_Blocked by: Phase 205-220 (Escapes Check)_

- [ ] Default eval( pattern
- [ ] Default instance_eval pattern
- [ ] Default class_eval pattern
- [ ] Default binding.pry pattern (forbid)
- [ ] Default byebug pattern (forbid)
- [ ] Default debugger pattern (forbid)
- [ ] METAPROGRAMMING comment requirement for eval patterns
- [ ] Test code exemption for metaprogramming escapes
- [ ] Unit tests for Ruby escape patterns

## Phase 486: Ruby Adapter - Suppress

_Blocked by: Phase 205-220 (Escapes Check)_

- [ ] # rubocop:disable detection (single cop)
- [ ] # rubocop:disable Cop1, Cop2 detection (multiple)
- [ ] # rubocop:todo detection
- [ ] # standard:disable detection
- [ ] Suppress check levels (forbid/comment/allow)
- [ ] Custom comment pattern for suppress
- [ ] Per-cop allow list (no comment needed)
- [ ] Per-cop forbid list (never allowed)
- [ ] Separate source vs test suppress policies
- [ ] Unit tests for rubocop directive parsing

## Phase 487: Ruby Adapter - Policy

_Blocked by: Phase 325 (Rust Adapter - Policy) for pattern, Phase 705-720 for tests correlation_

- [ ] lint_changes = "standalone" enforcement
- [ ] Lint config file detection (.rubocop.yml, .rubocop_todo.yml, .standard.yml)
- [ ] Mixed change detection (lint config + source in same branch)
- [ ] Standalone PR requirement violation

### Checkpoint: Ruby Adapter Basic Complete
- [ ] `quench check` on fixtures/ruby-gem with no config produces useful output
- [ ] Ruby-specific escapes detected in fixtures/violations
- [ ] Output tests for Ruby adapter output

---

## Phase 488: Ruby Test Runners

_Blocked by: Phase 915 (Test Runners - Framework)_

### RSpec Runner
- [ ] bundle exec rspec --format json execution
- [ ] JSON output parsing
- [ ] Per-test timing extraction
- [ ] Pass/fail/pending status extraction
- [ ] Test count metrics

### Minitest Runner
- [ ] bundle exec rake test execution
- [ ] Output parsing (dots, F, E format)
- [ ] Per-test timing extraction (with minitest-reporters)
- [ ] Pass/fail/error status extraction
- [ ] Test count metrics

### Cucumber Runner
- [ ] bundle exec cucumber --format json execution
- [ ] JSON output parsing
- [ ] Per-scenario timing extraction
- [ ] Pass/fail/pending status extraction

### Runner Selection
- [ ] Auto-detect runner from presence of spec/ vs test/ vs features/
- [ ] Auto-detect runner from Gemfile dependencies
- [ ] Explicit runner configuration
- [ ] Integration test: run tests on fixtures/ruby-gem

## Phase 4881: Ruby Test Runners - Coverage

_Blocked by: Phase 488 (Ruby Test Runners)_

- [ ] SimpleCov integration
- [ ] Coverage report parsing (coverage/.resultset.json)
- [ ] Line coverage percentage extraction
- [ ] Per-file coverage data
- [ ] Coverage aggregation across test suites

### Checkpoint: Ruby Test Runner Complete
- [ ] `quench check --ci --tests` runs appropriate test runner on Ruby projects
- [ ] Per-test timing extracted
- [ ] Coverage metrics collected via SimpleCov
- [ ] Output tests for Ruby test runner output

---

## Phase 489: Ruby Profile Defaults

_Blocked by: Phase 1505-1510 (Init Command - Profile Detection/Config Generation)_

- [ ] Ruby profile defaults struct (escapes, suppress, policy)
- [ ] Profile enum includes "ruby" / "rb"
- [ ] Auto-detection: Gemfile → ruby profile
- [ ] Auto-detection: *.gemspec → ruby profile
- [ ] Auto-detection: config.ru → ruby profile
- [ ] Auto-detection: config/application.rb → ruby profile (Rails)
- [ ] Ruby profile defaults application in init

## Phase 4891: Ruby Landing the Plane

_Blocked by: Phase 1515 (Init Command - Landing the Plane)_

- [ ] Ruby Landing the Plane checklist items:
  - `bundle exec rubocop` (if .rubocop.yml exists)
  - `bundle exec standardrb` (if .standard.yml exists)
  - `bundle exec rspec` (if spec/ exists)
  - `bundle exec rake test` (if test/ exists and Minitest)
  - `bundle exec rails test` (if Rails project)
  - `bundle exec cucumber` (if features/ exists)
- [ ] Rails detection for test command selection
- [ ] Checklist merging with base items

### Checkpoint: Ruby Init Complete
- [ ] `quench init` on fixtures/ruby-gem auto-detects ruby profile
- [ ] `quench init --with ruby` creates Ruby-specific config
- [ ] `quench init --with ruby,claude` populates Landing the Plane with Ruby items

---

## Summary: Blocking Relationships

```
Phase 201 (Generic Adapter)
    ├── Phase 481 (Ruby Specs)
    └── Phase 483 (Ruby Detection)
            └── Phase 484 (Ruby Fixture) [parallel]

Phase 205-220 (Escapes Check)
    ├── Phase 485 (Ruby Escapes)
    └── Phase 486 (Ruby Suppress)

Phase 325 (Rust Policy) + Phase 705-720 (Tests Correlation)
    └── Phase 487 (Ruby Policy)

Phase 915 (Test Runner Framework)
    └── Phase 488 (Ruby Test Runners)
            └── Phase 4881 (Ruby Coverage)

Phase 1505-1510 (Init Profile System)
    └── Phase 489 (Ruby Profile Defaults)
            └── Phase 4891 (Ruby Landing the Plane)
```

## Parallel Execution Opportunities

These Ruby phases can run in parallel with other language adapters:

| Ruby Phase | Can Parallel With |
|------------|-------------------|
| 481-483 | Phase 451-455 (Go), Phase 491-493 (JS), Phase 401-420 (Shell) |
| 484 | Any fixture work |
| 485-486 | Any escapes work after framework done |
| 488-4881 | Phase 475-477 (Go runners), Phase 498 (JS runners) |
| 489-4891 | Phase 485-487 (Go profile), Phase 4991 (JS profile) |

## Ruby-Specific Considerations

### Framework Detection

Detect Ruby frameworks for test command selection:

| Indicator | Framework |
|-----------|-----------|
| `config/application.rb` | Rails |
| `config.ru` + no Rails | Rack/Sinatra |
| `spec/` directory | RSpec |
| `test/` directory | Minitest |
| `features/` directory | Cucumber |

### Gemfile Parsing

Parse Gemfile for test framework detection:

```ruby
# Gemfile
group :test do
  gem 'rspec'      # → RSpec runner
  gem 'minitest'   # → Minitest runner
  gem 'cucumber'   # → Cucumber runner
end
```

### RuboCop vs Standard

The adapter supports both RuboCop and Standard Ruby:
- RuboCop: `# rubocop:disable Cop/Name`
- Standard: `# standard:disable` (fewer rules, no configuration)

Detection priority: `.standard.yml` existence → use Standard, otherwise → use RuboCop
