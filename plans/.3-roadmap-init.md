# quench init Roadmap

This roadmap covers updating `quench init` to match the spec in `docs/specs/commands/quench-init.md`.
Phases use 15xx numbering (init command range).

## Current vs Spec Differences

| Feature | Current | Spec |
|---------|---------|------|
| Profile flag | `--profile` | `--with` |
| Language auto-detection | Not implemented | Detect from markers |
| Agent auto-detection | Not implemented | Detect from files |
| Default output | Minimal `version = 1` | Full template with explicit checks |
| Language sections | Full config blocks | Dotted keys: `rust.cloc.check`, etc. |
| Agent config | Not updated | Updates `[check.agents].required` |
| `[lang.cloc]` | Not supported | `check` and `advice` fields |
| `[lang.policy].check` | Not supported | `check` field |

---

## Phase 1505: Init Command - Specs

- [ ] Spec: `--with` flag accepts comma-separated profiles
- [ ] Spec: `--with` skips auto-detection
- [ ] Spec: no `--with` triggers auto-detection
- [ ] Spec: language detection finds Cargo.toml → rust
- [ ] Spec: language detection finds go.mod → golang
- [ ] Spec: language detection finds package.json → javascript
- [ ] Spec: language detection finds *.sh in root/bin/scripts → shell
- [ ] Spec: agent detection finds CLAUDE.md → claude
- [ ] Spec: agent detection finds .cursorrules → cursor
- [ ] Spec: agent detection finds .cursor/rules/*.md[c] → cursor
- [ ] Spec: detection is additive (multiple languages/agents)
- [ ] Spec: output matches templates/init.default.toml format
- [ ] Spec: detected language appends `[lang]` section with dotted keys
- [ ] Spec: detected agent updates `[check.agents].required`

## Phase 1510: Rename --profile to --with

- [ ] Rename `profile` field in `InitArgs` to `with_profiles`
- [ ] Update clap arg from `--profile` to `--with`
- [ ] Update all tests using `--profile` to use `--with`
- [ ] Update docs/specs/01-cli.md references (already done)
- [ ] Update docs/specs/langs/*.md references (already done)

## Phase 1515: Init Output Template

- [ ] Create template generator matching `init.default.toml`
- [ ] Output explicit `check = "error"` for enabled checks
- [ ] Output `check = "off"` with stub comments for disabled checks
- [ ] Output `# Supported Languages:` comment line
- [ ] Output `# [rust], [golang], [javascript], [shell]` comment line

## Phase 1520: Language Auto-Detection

- [ ] Detect Rust: `Cargo.toml` exists
- [ ] Detect Go: `go.mod` exists
- [ ] Detect JavaScript: `package.json`, `tsconfig.json`, or `jsconfig.json` exists
- [ ] Detect Shell: `*.sh` in root, `bin/`, or `scripts/`
- [ ] Return list of detected languages
- [ ] Skip detection when `--with` specified

## Phase 1525: Agent Auto-Detection

- [ ] Detect Claude: `CLAUDE.md` exists
- [ ] Detect Cursor: `.cursorrules` or `.cursor/rules/*.md[c]` exists
- [ ] Return list of detected agents
- [ ] Skip detection when `--with` specified

## Phase 1530: Language Section Output

- [ ] Generate `[lang]` section header for each detected language
- [ ] Generate `lang.cloc.check = "error"` line
- [ ] Generate `lang.suppress.check = "comment"` line (or `"forbid"` for shell)
- [ ] Generate `lang.policy.check = "error"` line
- [ ] Append after `# Supported Languages:` comment block

## Phase 1535: Agent Config Output

- [ ] Update `[check.agents]` section when agents detected
- [ ] Add `required = ["CLAUDE.md"]` for claude
- [ ] Add `required = [".cursorrules"]` for cursor
- [ ] Merge required lists when both detected

## Phase 1540: Config Schema - [lang.cloc] - Specs

For each language (rust, golang, javascript, shell):

- [ ] Spec: `{lang}.cloc.check = "off"` disables cloc for that language's files
- [ ] Spec: `{lang}.cloc.check = "warn"` reports but doesn't fail
- [ ] Spec: `{lang}.cloc.advice` overrides default advice for that language
- [ ] Spec: each language can have independent cloc check level
- [ ] Spec: unset `{lang}.cloc.check` inherits from `check.cloc.check`

## Phase 1542: Config Schema - [lang.cloc] - Implementation

- [ ] Add `ClocConfig` struct with `check` and `advice` fields
- [ ] Add `cloc` field to `RustConfig`, `GolangConfig`, `JavaScriptConfig`, `ShellConfig`
- [ ] Parse `[rust.cloc]`, `[golang.cloc]`, `[javascript.cloc]`, `[shell.cloc]` sections
- [ ] Cloc check respects per-language check level
- [ ] Cloc check uses per-language advice in violations
- [ ] Unit tests for per-language cloc config

## Phase 1545: Config Schema - [lang.policy].check - Specs

For each language (rust, golang, javascript, shell):

- [ ] Spec: `{lang}.policy.check = "off"` disables policy for that language
- [ ] Spec: `{lang}.policy.check = "warn"` reports but doesn't fail
- [ ] Spec: each language can have independent policy check level

## Phase 1547: Config Schema - [lang.policy].check - Implementation

- [ ] Add `check` field to `PolicyConfig` struct
- [ ] Parse `[rust.policy]`, `[golang.policy]`, `[javascript.policy]`, `[shell.policy]` check fields
- [ ] Policy check respects per-language check level
- [ ] Unit tests for per-language policy config

### Checkpoint: Init Command Complete

- [ ] `quench init` on empty dir creates full template
- [ ] `quench init` on Rust project detects and adds `[rust]` section
- [ ] `quench init` on project with CLAUDE.md updates `[check.agents]`
- [ ] `quench init --with shell` creates shell-only config
- [ ] `quench init --with rust,claude` creates combined config
- [ ] All existing init tests updated and passing

---

## Test Updates Required

| File | Change |
|------|--------|
| `tests/specs/cli/init.rs` | Replace `--profile` with `--with` |
| `tests/specs/cli/init.rs` | Update expected output format |
| `tests/specs/cli/init.rs` | Add auto-detection tests |
