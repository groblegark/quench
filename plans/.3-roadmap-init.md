# quench init Roadmap

This roadmap covers updating `quench init` to match the spec in `docs/specs/commands/quench-init.md`.
Phases use 15xx numbering (init command range).

## Current vs Spec Differences

| Feature | Current | Spec | Status |
|---------|---------|------|--------|
| Profile flag | `--with` | `--with` | ✓ Complete |
| Language auto-detection | Detect from markers | Detect from markers | ✓ Complete |
| Agent auto-detection | Detect from files | Detect from files | ✓ Complete |
| Default output | Full template | Full template with explicit checks | ✓ Complete |
| Language sections | Full config blocks | Full config blocks | ✓ Complete |
| Agent config | Updates `[check.agents].required` | Updates `[check.agents].required` | ✓ Complete |
| `[lang.cloc]` | Not supported | `check` and `advice` fields | ✓ Complete |
| `[lang.policy].check` | Not supported | `check` field | ✓ Complete |

---

## Phase 1505: Init Command - Specs

- [x] Spec: `--with` flag accepts comma-separated profiles
- [x] Spec: `--with` skips auto-detection
- [x] Spec: no `--with` triggers auto-detection
- [x] Spec: language detection finds Cargo.toml → rust
- [x] Spec: language detection finds go.mod → golang
- [x] Spec: language detection finds package.json → javascript
- [x] Spec: language detection finds *.sh in root/bin/scripts → shell
- [x] Spec: agent detection finds CLAUDE.md → claude
- [x] Spec: agent detection finds .cursorrules → cursor
- [x] Spec: agent detection finds .cursor/rules/*.md[c] → cursor
- [x] Spec: detection is additive (multiple languages/agents)
- [x] Spec: output matches templates/init.default.toml format
- [x] Spec: detected language appends `[lang]` section with dotted keys
- [x] Spec: detected agent updates `[check.agents].required`

## Phase 1510: Rename --profile to --with

- [x] Rename `profile` field in `InitArgs` to `with_profiles`
- [x] Update clap arg from `--profile` to `--with`
- [x] Update all tests using `--profile` to use `--with`
- [x] Update docs/specs/01-cli.md references (already done)
- [x] Update docs/specs/langs/*.md references (already done)

## Phase 1515: Init Output Template

- [x] Create template generator matching `init.default.toml`
- [x] Output explicit `check = "error"` for enabled checks
- [x] Output `check = "off"` with stub comments for disabled checks
- [x] Output `# Supported Languages:` comment line
- [x] Output `# [rust], [golang], [javascript], [shell]` comment line

## Phase 1520: Language Auto-Detection

- [x] Detect Rust: `Cargo.toml` exists
- [x] Detect Go: `go.mod` exists
- [x] Detect JavaScript: `package.json`, `tsconfig.json`, or `jsconfig.json` exists
- [x] Detect Shell: `*.sh` in root, `bin/`, or `scripts/`
- [x] Return list of detected languages
- [x] Skip detection when `--with` specified

## Phase 1525: Agent Auto-Detection

- [x] Detect Claude: `CLAUDE.md` exists
- [x] Detect Cursor: `.cursorrules` or `.cursor/rules/*.md[c]` exists
- [x] Return list of detected agents
- [x] Skip detection when `--with` specified

## Phase 1530: Language Section Output

- [x] Generate `[lang]` section header for each detected language
- [x] Generate `lang.cloc.check = "error"` line
- [x] Generate `lang.suppress.check = "comment"` line (or `"forbid"` for shell)
- [x] Generate `lang.policy.check = "error"` line
- [x] Append after `# Supported Languages:` comment block

## Phase 1535: Agent Config Output

- [x] Update `[check.agents]` section when agents detected
- [x] Add `required = ["CLAUDE.md"]` for claude
- [x] Add `required = [".cursorrules"]` for cursor
- [x] Merge required lists when both detected

## Phase 1540: Config Schema - [lang.cloc] - Specs

For each language (rust, golang, javascript, shell):

- [x] Spec: `{lang}.cloc.check = "off"` disables cloc for that language's files
- [x] Spec: `{lang}.cloc.check = "warn"` reports but doesn't fail
- [x] Spec: `{lang}.cloc.advice` overrides default advice for that language
- [x] Spec: each language can have independent cloc check level
- [x] Spec: unset `{lang}.cloc.check` inherits from `check.cloc.check`

## Phase 1542: Config Schema - [lang.cloc] - Implementation

- [x] Add `ClocConfig` struct with `check` and `advice` fields
- [x] Add `cloc` field to `RustConfig`, `GolangConfig`, `JavaScriptConfig`, `ShellConfig`
- [x] Parse `[rust.cloc]`, `[golang.cloc]`, `[javascript.cloc]`, `[shell.cloc]` sections
- [x] Cloc check respects per-language check level
- [x] Cloc check uses per-language advice in violations
- [x] Unit tests for per-language cloc config

## Phase 1545: Config Schema - [lang.policy].check - Specs

For each language (rust, golang, javascript, shell):

- [x] Spec: `{lang}.policy.check = "off"` disables policy for that language
- [x] Spec: `{lang}.policy.check = "warn"` reports but doesn't fail
- [x] Spec: each language can have independent policy check level

## Phase 1547: Config Schema - [lang.policy].check - Implementation

- [x] Add `check` field to `PolicyConfig` struct
- [x] Parse `[rust.policy]`, `[golang.policy]`, `[javascript.policy]`, `[shell.policy]` check fields
- [x] Policy check respects per-language check level
- [x] Unit tests for per-language policy config

### Checkpoint: Init Command Complete

- [x] `quench init` on empty dir creates full template
- [x] `quench init` on Rust project detects and adds `[rust]` section
- [x] `quench init` on project with CLAUDE.md updates `[check.agents]`
- [x] `quench init --with shell` creates shell-only config
- [x] `quench init --with rust,claude` creates combined config
- [x] All existing init tests updated and passing

---

## Test Updates Required

| File | Change |
|------|--------|
| `tests/specs/cli/init.rs` | ~~Replace `--profile` with `--with`~~ ✓ Complete |
| `tests/specs/cli/init.rs` | ~~Update expected output format~~ ✓ Complete |
| `tests/specs/cli/init.rs` | ~~Add auto-detection tests~~ ✓ Complete |
