# Vitest Coverage Collection - Implementation Plan

Phase 4981 from `.2-roadmap-javascript.md`.

## Overview

Enable end-to-end Vitest coverage reporting. The core implementation (detection, execution, LCOV parsing) is complete. Behavioral tests fail because npm modules aren't installed in fixtures. This plan addresses fixture setup, coverage provider configuration, and integration test enablement.

## Current State

**Implemented:**
- `js_detect.rs` - Auto-detects vitest from config files, devDependencies, test scripts
- `vitest.rs` - Executes tests, parses JSON output, collects per-test timing
- `js_coverage.rs` - Runs `vitest run --coverage --coverage.reporter=lcov`, parses LCOV

**Blocked:**
- Behavioral tests in `tests/specs/checks/tests/coverage.rs` marked `#[ignore = "TODO: Phase 4981 - Requires npm install"]`
- Fixture `js-simple` lacks coverage provider dependency

## Project Structure

```
tests/fixtures/js-simple/
├── package.json          # Add @vitest/coverage-v8
├── vitest.config.ts      # Add coverage provider config
├── node_modules/         # Created by npm install (gitignored)
├── package-lock.json     # Created by npm install (committed)
└── ...

scripts/fixtures/
└── setup-js-fixtures.sh  # New: installs npm modules

tests/specs/checks/tests/
├── coverage.rs           # Enable vitest/jest coverage tests
└── js_runners.rs         # Enable vitest detection test
```

## Dependencies

**Runtime (fixture):**
- `vitest ^2.0.0` (already present)
- `@vitest/coverage-v8 ^2.0.0` (new)
- `typescript ^5.0.0` (already present)

**CI:**
- Node.js 18+ (for fixture npm install)

## Implementation Phases

### Phase 1: Fixture Coverage Provider

Add coverage provider to `js-simple` fixture so vitest can generate LCOV reports.

**Files:**
- `tests/fixtures/js-simple/package.json` - Add `@vitest/coverage-v8`
- `tests/fixtures/js-simple/vitest.config.ts` - Configure coverage provider

**package.json change:**
```json
{
  "devDependencies": {
    "@vitest/coverage-v8": "^2.0.0",
    "vitest": "^2.0.0",
    "typescript": "^5.0.0"
  }
}
```

**vitest.config.ts change:**
```typescript
export default defineConfig({
  test: {
    include: ['tests/**/*.test.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['lcov'],
    },
  },
});
```

**Verification:** `cd tests/fixtures/js-simple && npm install && npx vitest run --coverage` produces `coverage/lcov.info`

### Phase 2: Fixture Setup Script

Create setup script to install npm modules for JS fixtures.

**Files:**
- `scripts/fixtures/setup-js-fixtures.sh` - New script
- `scripts/fixtures/setup-test-fixtures.sh` - Call new script

**setup-js-fixtures.sh:**
```bash
#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")/../../tests/fixtures"

for fixture in js-simple js-monorepo; do
  if [ -f "$fixture/package.json" ]; then
    echo "Installing npm modules for $fixture..."
    (cd "$fixture" && npm install --silent)
  fi
done
```

**Verification:** `./scripts/fixtures/setup-js-fixtures.sh` installs node_modules without errors

### Phase 3: Commit Lockfile

Commit `package-lock.json` so CI can use `npm ci` for reproducible installs.

**Files:**
- `tests/fixtures/js-simple/package-lock.json` - Commit (generated by npm install)
- `.gitignore` - Ensure `node_modules/` is ignored but `package-lock.json` is not

**Verification:** `git status` shows lockfile tracked, `node_modules/` ignored

### Phase 4: Enable Behavioral Tests

Remove `#[ignore]` from vitest coverage tests and verify they pass.

**Files:**
- `tests/specs/checks/tests/coverage.rs`:
  - `vitest_runner_collects_javascript_coverage()` - Line 360
  - `jest_runner_collects_javascript_coverage()` - Line 301
  - `multiple_js_suite_coverages_merged()` - Line 478
- `tests/specs/checks/tests/js_runners.rs`:
  - `auto_detects_vitest_on_js_simple_fixture()` - Line 221

**Verification:** `cargo test --test specs -- vitest` passes

### Phase 5: CI Setup (if needed)

Ensure CI pipeline installs npm modules before running specs.

**Files:**
- `.github/workflows/ci.yml` or equivalent - Add npm install step

**CI step:**
```yaml
- name: Setup JS fixtures
  run: ./scripts/fixtures/setup-js-fixtures.sh
```

**Verification:** CI pipeline passes with JS coverage tests enabled

## Key Implementation Details

### Coverage Flow

```
VitestRunner::run()
├─ Execute: npx vitest run --reporter=json
├─ Parse JSON for per-test timing
├─ If ctx.collect_coverage:
│  └─ collect_vitest_coverage()
│     ├─ Execute: npx vitest run --coverage --coverage.reporter=lcov
│     ├─ Read: coverage/lcov.info
│     ├─ Parse LCOV (LH/LF per file)
│     ├─ Normalize paths, exclude node_modules
│     └─ Return CoverageResult
└─ result.with_collected_coverage(coverage, "javascript")
```

### Vitest Coverage Requirements

Vitest requires explicit coverage provider:
- `@vitest/coverage-v8` - Uses V8's built-in coverage (fast, less accurate)
- `@vitest/coverage-istanbul` - Uses Istanbul (slower, more accurate)

Without the provider package, `--coverage` silently produces no output.

### LCOV Format

The parsing in `js_coverage.rs` handles standard LCOV:
```
SF:/path/to/source.ts
LH:42    # Lines hit
LF:50    # Lines found (total)
end_of_record
```

### Test Fixture Structure

`js-simple` provides a minimal TypeScript project:
```
src/index.ts     # Main module (covered by tests/index.test.ts)
src/utils.ts     # Utilities (covered by tests/utils.test.ts)
```

Coverage should report ~50% if only one file's function is called per test.

## Verification Plan

1. **Unit tests pass:**
   ```bash
   cargo test --lib checks::tests::runners::vitest
   cargo test --lib checks::tests::runners::js_coverage
   cargo test --lib checks::tests::runners::js_detect
   ```

2. **Manual coverage collection:**
   ```bash
   cd tests/fixtures/js-simple
   npm install
   npx vitest run --coverage --coverage.reporter=lcov
   cat coverage/lcov.info  # Should contain SF, LH, LF entries
   ```

3. **Behavioral tests pass:**
   ```bash
   ./scripts/fixtures/setup-js-fixtures.sh
   cargo test --test specs -- vitest
   cargo test --test specs -- jest  # If fixture also supports Jest
   ```

4. **Full check:**
   ```bash
   make check
   ```

5. **Integration test:**
   ```bash
   cargo run -- check tests --ci
   # Should report JavaScript coverage in metrics
   ```

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| npm install slow in CI | Use `npm ci` with committed lockfile |
| Coverage provider version mismatch | Pin exact vitest/coverage-v8 versions |
| node_modules bloats repo | Ensure `.gitignore` excludes it |
| Fixture tests flaky | Run with `--test-threads=1` if needed |
