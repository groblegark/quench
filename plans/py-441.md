# Phase 441: Python Adapter - Specs

Add behavioral specifications for the Python language adapter.

## Overview

This phase creates behavioral specs that define how the Python adapter should work. All specs use `#[ignore = "TODO: Phase 443 - Python Detection"]` since the adapter implementation comes in Phase 443.

## Project Structure

```
tests/
├── specs/
│   └── adapters/
│       ├── mod.rs          # Add: pub mod python;
│       └── python.rs       # NEW: Python adapter specs
└── fixtures/
    └── python/             # NEW: Python test fixtures
        ├── auto-detect/    # pyproject.toml only
        ├── setup-py/       # setup.py detection
        ├── setup-cfg/      # setup.cfg detection
        ├── requirements/   # requirements.txt fallback
        ├── src-layout/     # src/package/ structure
        ├── flat-layout/    # package/ structure
        ├── escape-fail/    # eval/exec without comment
        ├── escape-ok/      # eval/exec with comment
        ├── debugger-fail/  # breakpoint()/pdb
        └── suppress-fail/  # noqa/type:ignore without reason
docs/
└── specs/
    └── langs/
        └── python.md       # NEW: Python adapter specification
```

## Dependencies

- Phase 201 (Generic Language Adapter) - Required for adapter trait
- Phase 205-220 (Escapes Check Framework) - Required for escape/suppress specs

## Implementation Phases

### Phase 1: Specification Document

Create `docs/specs/langs/python.md` defining Python adapter behavior.

```markdown
# Python Language Adapter

## Detection

Python adapter activates when any of these files exist:
- `pyproject.toml`
- `setup.py`
- `setup.cfg`
- `requirements.txt` (fallback)

## Default Patterns

| Pattern Type | Patterns |
|--------------|----------|
| source | `**/*.py` |
| tests | `tests/**/*.py`, `test_*.py`, `*_test.py`, `conftest.py` |
| ignore | `.venv/`, `__pycache__/`, `.mypy_cache/`, `.pytest_cache/`, `dist/`, `build/`, `*.egg-info/` |

## Package Detection

### From pyproject.toml

```toml
[project]
name = "my-package"
```

### From setup.py

```python
setup(name="my-package", ...)
```

### From Directory Structure

- **src-layout**: `src/package_name/__init__.py`
- **flat-layout**: `package_name/__init__.py`

## Escape Patterns

| Pattern | Action | Comment Required |
|---------|--------|------------------|
| `eval(` | comment | `# EVAL:` |
| `exec(` | comment | `# EXEC:` |
| `__import__(` | comment | `# DYNAMIC:` |
| `breakpoint()` | forbid | - |
| `pdb.set_trace()` | forbid | - |
| `import pdb` | forbid | - |

## Suppress Patterns

| Pattern | Default Action |
|---------|----------------|
| `# noqa` | comment (when configured) |
| `# noqa: CODE` | comment (when configured) |
| `# type: ignore` | comment (when configured) |
| `# type: ignore[code]` | comment (when configured) |
| `# pylint: disable=` | comment (when configured) |

## Configuration

```toml
[python]
# Patterns can be overridden
# source = ["**/*.py"]
# tests = ["tests/**/*.py", "test_*.py", "*_test.py", "conftest.py"]
# ignore = [".venv/", "__pycache__/", ...]

[python.suppress]
check = "comment"  # forbid | comment | allow (default: allow)

[python.suppress.source]
check = "comment"  # Override for source files

[python.suppress.test]
check = "allow"    # Override for test files

[python.policy]
lint_changes = "standalone"  # standalone | allow
lint_config = [
    "pyproject.toml",  # when [tool.ruff], [tool.black], etc. present
    "ruff.toml",
    ".ruff.toml",
    ".flake8",
    ".pylintrc",
    "pylintrc",
    "mypy.ini",
    ".mypy.ini",
    "setup.cfg",  # when [flake8] or [mypy] sections present
]
```
```

### Phase 2: Test Fixtures

Create minimal Python project fixtures in `tests/fixtures/python/`.

**Fixture: `python/auto-detect/`**
```
pyproject.toml    # [project]\nname = "test-project"
src/app.py        # def main(): pass
tests/test_app.py # def test_main(): pass
quench.toml       # version = 1
CLAUDE.md         # Minimal
```

**Fixture: `python/setup-py/`**
```
setup.py          # from setuptools import setup; setup(name="test-project")
app.py            # def main(): pass
quench.toml       # version = 1
CLAUDE.md         # Minimal
```

**Fixture: `python/escape-fail/`**
```
pyproject.toml
src/dynamic.py    # result = eval(expr)  # No comment
quench.toml       # version = 1
CLAUDE.md
```

**Fixture: `python/escape-ok/`**
```
pyproject.toml
src/dynamic.py    # # EVAL: User-provided math expression\nresult = eval(expr)
quench.toml       # version = 1
CLAUDE.md
```

**Fixture: `python/debugger-fail/`**
```
pyproject.toml
src/debug.py      # breakpoint()  # OR: import pdb; pdb.set_trace()
quench.toml       # version = 1
CLAUDE.md
```

**Fixture: `python/suppress-fail/`**
```
pyproject.toml
src/messy.py      # x = 1  # noqa
quench.toml       # [python.suppress]\ncheck = "comment"
CLAUDE.md
```

### Phase 3: Spec File Structure

Create `tests/specs/adapters/python.rs` with all specs marked as ignored.

```rust
//! Behavioral specs for the Python language adapter.
//!
//! Tests that quench correctly:
//! - Detects Python projects via pyproject.toml, setup.py, setup.cfg, requirements.txt
//! - Applies default source/test/ignore patterns
//! - Detects package name from config files and directory structure
//! - Applies Python-specific escape patterns
//! - Applies Python-specific suppress patterns
//! - Enforces lint config standalone policy
//!
//! Reference: docs/specs/langs/python.md

#![allow(clippy::unwrap_used, clippy::expect_used)]

use crate::prelude::*;

// =============================================================================
// AUTO-DETECTION SPECS
// =============================================================================

/// Spec: docs/specs/langs/python.md#detection
///
/// > Python adapter activates when pyproject.toml exists
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_auto_detected_when_pyproject_toml_present() {
    let result = cli().on("python/auto-detect").json().passes();
    let checks = result.checks();
    assert!(checks.iter().any(|c|
        c.get("name").and_then(|n| n.as_str()) == Some("escapes")
    ));
}

// ... (all other specs)
```

### Phase 4: Auto-Detection Specs

Write specs for each detection method:

```rust
// pyproject.toml detection (primary)
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_auto_detected_when_pyproject_toml_present() { ... }

// setup.py detection
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_auto_detected_when_setup_py_present() { ... }

// setup.cfg detection
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_auto_detected_when_setup_cfg_present() { ... }

// requirements.txt fallback detection
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_auto_detected_when_requirements_txt_present() { ... }
```

### Phase 5: Pattern Specs

Write specs for default patterns:

```rust
// Source pattern
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_default_source_pattern_matches_py_files() {
    let cloc = check("cloc").on("python/auto-detect").json().passes();
    let metrics = cloc.require("metrics");
    let source_lines = metrics.get("source_lines").and_then(|v| v.as_u64()).unwrap_or(0);
    assert!(source_lines > 0, "should count .py files as source");
}

// Test patterns
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_default_test_pattern_matches_test_files() { ... }

// Ignore patterns
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_default_ignores_venv_directory() { ... }

#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_default_ignores_pycache_directory() { ... }
```

### Phase 6: Package Detection Specs

Write specs for package name detection:

```rust
// From pyproject.toml [project.name]
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_detects_package_name_from_pyproject_toml() { ... }

// From setup.py name argument
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_detects_package_name_from_setup_py() { ... }

// From src-layout directory structure
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_detects_src_layout_package() { ... }

// From flat-layout directory structure
#[test]
#[ignore = "TODO: Phase 443 - Python Detection"]
fn python_adapter_detects_flat_layout_package() { ... }
```

## Key Implementation Details

### Spec Organization

Group specs by concern with section headers:
1. AUTO-DETECTION SPECS
2. DEFAULT PATTERN SPECS
3. PACKAGE DETECTION SPECS
4. ESCAPE PATTERN SPECS
5. SUPPRESS PATTERN SPECS
6. LINT CONFIG POLICY SPECS

### Ignore Tag Convention

All specs use `#[ignore = "TODO: Phase 443 - Python Detection"]` for detection specs, `#[ignore = "TODO: Phase 445 - Python Escapes"]` for escape specs, etc.

### Fixture Conventions

- Each fixture is self-contained with `quench.toml` and `CLAUDE.md`
- Fixtures named by what they test: `escape-fail/`, `escape-ok/`
- Minimal files - only what's needed to trigger the behavior

### Test Helper Usage

```rust
// Use Project for config-dependent tests
let temp = Project::empty();
temp.config(r#"
[python.suppress]
check = "comment"
"#);
temp.file("pyproject.toml", "[project]\nname = \"test\"");
temp.file("src/app.py", "x = 1  # noqa");
check("escapes").pwd(temp.path()).fails();
```

## Verification Plan

1. **Compile check**: `cargo test --test specs -- python --no-run`
2. **Ignored count**: `cargo test --test specs -- python --ignored 2>&1 | grep "ignored"`
3. **Doc reference**: Each spec's doc comment references the spec document section
4. **Fixture validity**: Each fixture directory has required files

## Checklist

- [ ] Create `docs/specs/langs/python.md`
- [ ] Create test fixtures in `tests/fixtures/python/`
- [ ] Create `tests/specs/adapters/python.rs`
- [ ] Add `pub mod python;` to `tests/specs/adapters/mod.rs`
- [ ] Update `docs/specs/10-language-adapters.md` to include Python
- [ ] Verify all specs compile with `cargo test --test specs -- python --no-run`
- [ ] Verify ignored count matches expected (~25-30 specs)
