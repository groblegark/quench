# Python Language Adapter Roadmap

This roadmap covers adding Python language support to quench.
Phases use 44x numbering (before Go 45x, after Shell 4xx).

## Dependencies from .0-outline

| This Phase | Blocked By | Reason |
|------------|------------|--------|
| 441 | Phase 201 | Requires adapter trait definition |
| 443 | Phase 201 | Requires adapter trait definition |
| 445 | Phase 205-220 | Requires escapes check framework |
| 446 | Phase 205-220 | Requires escapes check framework |
| 447 | Phase 705-720 | Requires tests check correlation |
| 448 | Phase 915 | Requires test runner framework |
| 449 | Phase 1505-1510 | Requires init command profile system |

---

## Phase 441: Python Adapter - Specs

_Blocked by: Phase 201 (Generic Language Adapter)_

- [ ] Spec: auto-detected when pyproject.toml, setup.py, setup.cfg, or requirements.txt present
- [ ] Spec: default source pattern **/*.py
- [ ] Spec: default test patterns tests/**/*.py, test_*.py, *_test.py, conftest.py
- [ ] Spec: default ignores .venv/, __pycache__/, .mypy_cache/, .pytest_cache/, dist/, build/, *.egg-info/
- [ ] Spec: detects package name from pyproject.toml or setup.py
- [ ] Spec: detects packages from directory structure (src/ layout or flat)
- [ ] Spec: `eval(` without # EVAL: comment fails
- [ ] Spec: `exec(` without # EXEC: comment fails
- [ ] Spec: `__import__(` without # DYNAMIC: comment fails
- [ ] Spec: `breakpoint()` forbidden in source code
- [ ] Spec: `pdb.set_trace()` forbidden in source code
- [ ] Spec: # noqa without comment fails (when configured)
- [ ] Spec: # type: ignore without comment fails (when configured)
- [ ] Spec: lint config changes with source changes fails standalone policy

## Phase 443: Python Adapter - Detection

_Blocked by: Phase 201 (Generic Language Adapter)_

- [ ] pyproject.toml detection
- [ ] setup.py detection
- [ ] setup.cfg detection
- [ ] requirements.txt detection (fallback)
- [ ] Default source patterns (**/*.py)
- [ ] Default test patterns (tests/**/*.py, test_*.py, *_test.py, conftest.py)
- [ ] Default ignore patterns (.venv/, __pycache__/, .mypy_cache/, .pytest_cache/, dist/, build/, *.egg-info/)
- [ ] Package name extraction from pyproject.toml [project.name]
- [ ] Package name extraction from setup.py (name= argument)
- [ ] Src-layout detection (src/package_name/)
- [ ] Flat-layout detection (package_name/)
- [ ] Integration test: detect packages in fixtures/python-project

## Phase 444: Python Test Fixture

_Blocked by: Phase 010 (Test Fixtures) - can run in parallel_

- [ ] fixtures/python-simple/ - small Python project with pyproject.toml, src/, tests/
- [ ] fixtures/python-poetry/ - Poetry project with poetry.lock
- [ ] fixtures/python-uv/ - uv project with uv.lock
- [ ] Add Python violations to fixtures/violations/
- [ ] Fixture README updates

## Phase 445: Python Adapter - Escapes

_Blocked by: Phase 205-220 (Escapes Check)_

- [ ] Default eval( pattern
- [ ] Default exec( pattern
- [ ] Default __import__( pattern
- [ ] Default compile( pattern (with mode='eval' or 'exec')
- [ ] Default breakpoint() pattern (forbid)
- [ ] Default pdb.set_trace() pattern (forbid)
- [ ] Default import pdb pattern (forbid)
- [ ] EVAL comment requirement for eval()
- [ ] EXEC comment requirement for exec()
- [ ] DYNAMIC comment requirement for __import__()
- [ ] Test code exemption for escape patterns
- [ ] Unit tests for Python escape patterns

## Phase 446: Python Adapter - Suppress

_Blocked by: Phase 205-220 (Escapes Check)_

- [ ] # noqa detection (all codes)
- [ ] # noqa: E501 detection (specific code)
- [ ] # noqa: E501, W503 detection (multiple codes)
- [ ] # type: ignore detection (all)
- [ ] # type: ignore[assignment] detection (specific)
- [ ] # pylint: disable=xxx detection
- [ ] # pragma: no cover detection
- [ ] Suppress check levels (forbid/comment/allow)
- [ ] Custom comment pattern for suppress
- [ ] Per-code allow list (no comment needed)
- [ ] Per-code forbid list (never allowed)
- [ ] Separate source vs test suppress policies
- [ ] Unit tests for suppress parsing

## Phase 447: Python Adapter - Policy

_Blocked by: Phase 325 (Rust Adapter - Policy) for pattern, Phase 705-720 for tests correlation_

- [ ] lint_changes = "standalone" enforcement
- [ ] Lint config file detection:
  - pyproject.toml ([tool.ruff], [tool.black], [tool.mypy], [tool.pylint])
  - ruff.toml, .ruff.toml
  - .flake8
  - .pylintrc, pylintrc
  - mypy.ini, .mypy.ini
  - setup.cfg ([flake8], [mypy] sections)
- [ ] Mixed change detection (lint config + source in same branch)
- [ ] Standalone PR requirement violation

### Checkpoint: Python Adapter Basic Complete
- [ ] `quench check` on fixtures/python-simple with no config produces useful output
- [ ] `quench check` on fixtures/python-poetry detects package
- [ ] Python-specific escapes detected in fixtures/violations
- [ ] Output tests for Python adapter output

---

## Phase 448: Python Test Runners

_Blocked by: Phase 915 (Test Runners - Framework)_

### Pytest Runner (already implemented)
- [x] pytest --durations=0 -v execution
- [x] Output parsing for per-test timing
- [x] Pass/fail status extraction
- [x] Test count metrics

### Unittest Runner
- [ ] python -m unittest discover execution
- [ ] Output parsing
- [ ] Pass/fail status extraction
- [ ] Test count metrics

### Runner Selection
- [ ] Auto-detect runner from pyproject.toml [tool.pytest] presence
- [ ] Auto-detect runner from pytest.ini presence
- [ ] Auto-detect runner from conftest.py presence
- [ ] Explicit runner configuration
- [ ] Integration test: run tests on fixtures/python-simple

## Phase 4481: Python Test Runners - Coverage

_Blocked by: Phase 448 (Python Test Runners)_

- [ ] coverage.py integration (coverage run -m pytest)
- [ ] pytest-cov integration (pytest --cov)
- [ ] Coverage report parsing (.coverage, coverage.xml, coverage.json)
- [ ] Line coverage percentage extraction
- [ ] Per-file coverage data
- [ ] Branch coverage support (optional)
- [ ] Coverage aggregation across test suites

### Checkpoint: Python Test Runner Complete
- [ ] `quench check --ci --tests` runs pytest on Python projects
- [ ] Per-test timing extracted from pytest output
- [ ] Coverage metrics collected via coverage.py
- [ ] Output tests for Python test runner output

---

## Phase 449: Python Profile Defaults

_Blocked by: Phase 1505-1510 (Init Command - Profile Detection/Config Generation)_

- [ ] Python profile defaults struct (escapes, suppress, policy)
- [ ] Profile enum includes "python" / "py"
- [ ] Auto-detection: pyproject.toml → python profile
- [ ] Auto-detection: setup.py → python profile
- [ ] Auto-detection: requirements.txt → python profile
- [ ] Python profile defaults application in init

## Phase 4491: Python Landing the Plane

_Blocked by: Phase 1515 (Init Command - Landing the Plane)_

- [ ] Python Landing the Plane checklist items:
  - `ruff check .` (if ruff.toml or [tool.ruff] exists)
  - `ruff format --check .` (if ruff configured)
  - `black --check .` (if [tool.black] exists)
  - `mypy .` (if mypy.ini or [tool.mypy] exists)
  - `flake8` (if .flake8 exists)
  - `pylint **/*.py` (if .pylintrc exists)
  - `pytest` (if tests/ or conftest.py exists)
  - `python -m build` (if build configured)
- [ ] Package manager detection (pip/poetry/uv/pipenv)
- [ ] Checklist merging with base items

### Checkpoint: Python Init Complete
- [ ] `quench init` on fixtures/python-simple auto-detects python profile
- [ ] `quench init --with python` creates Python-specific config
- [ ] `quench init --with python,claude` populates Landing the Plane with Python items

---

## Summary: Blocking Relationships

```
Phase 201 (Generic Adapter)
    ├── Phase 441 (Python Specs)
    └── Phase 443 (Python Detection)
            └── Phase 444 (Python Fixture) [parallel]

Phase 205-220 (Escapes Check)
    ├── Phase 445 (Python Escapes)
    └── Phase 446 (Python Suppress)

Phase 325 (Rust Policy) + Phase 705-720 (Tests Correlation)
    └── Phase 447 (Python Policy)

Phase 915 (Test Runner Framework)
    └── Phase 448 (Python Test Runners)
            └── Phase 4481 (Python Coverage)

Phase 1505-1510 (Init Profile System)
    └── Phase 449 (Python Profile Defaults)
            └── Phase 4491 (Python Landing the Plane)
```

## Parallel Execution Opportunities

These Python phases can run in parallel with other language adapters:

| Python Phase | Can Parallel With |
|--------------|-------------------|
| 441-443 | Phase 451-455 (Go), Phase 481-483 (Ruby), Phase 491-493 (JS), Phase 401-420 (Shell) |
| 444 | Any fixture work |
| 445-446 | Any escapes work after framework done |
| 448-4481 | Phase 475-477 (Go runners), Phase 488 (Ruby runners), Phase 498 (JS runners) |
| 449-4491 | Phase 485-487 (Go profile), Phase 489 (Ruby profile), Phase 4991 (JS profile) |

## Python-Specific Considerations

### Package Manager Detection

Detect and adapt to the project's package manager:

| Indicator | Package Manager |
|-----------|-----------------|
| `uv.lock` | uv |
| `poetry.lock` | poetry |
| `Pipfile.lock` / `Pipfile` | pipenv |
| `requirements.txt` | pip |
| `pyproject.toml` (no lock) | pip (modern) |
| `environment.yml` | conda |

### Project Layout Detection

Support common Python project layouts:

| Pattern | Layout |
|---------|--------|
| `src/package_name/__init__.py` | src-layout (recommended) |
| `package_name/__init__.py` | flat-layout |
| `setup.py` only | legacy layout |

### Linter Ecosystem

Python has a fragmented linter ecosystem. Detection priority:

| Tool | Config Files |
|------|--------------|
| Ruff (modern, fast) | ruff.toml, .ruff.toml, pyproject.toml [tool.ruff] |
| Black (formatter) | pyproject.toml [tool.black] |
| Flake8 (legacy) | .flake8, setup.cfg [flake8] |
| Pylint (comprehensive) | .pylintrc, pylintrc, pyproject.toml [tool.pylint] |
| Mypy (type checker) | mypy.ini, .mypy.ini, pyproject.toml [tool.mypy] |

### Framework Detection

Detect Python frameworks for additional context:

| Indicator | Framework |
|-----------|-----------|
| `manage.py` + `settings.py` | Django |
| `app.py` + Flask import | Flask |
| `main.py` + FastAPI import | FastAPI |
| `wsgi.py` or `asgi.py` | Generic WSGI/ASGI |

### Test Framework Detection

| Indicator | Framework |
|-----------|-----------|
| `conftest.py` or `pytest.ini` | pytest |
| `pyproject.toml [tool.pytest]` | pytest |
| `test_*.py` with unittest imports | unittest |
| `noxfile.py` | nox (test runner) |
| `tox.ini` | tox (test runner) |

### Type Checking Considerations

Python type ignore patterns are contextual:

- `# type: ignore` - suppress all mypy errors on line
- `# type: ignore[assignment]` - suppress specific error code
- `# type: ignore[arg-type, return-value]` - suppress multiple codes

The adapter should distinguish between blanket ignores (discouraged) and specific ignores (acceptable with reason).
