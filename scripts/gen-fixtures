#!/usr/bin/env bash
# scripts/gen-fixtures - Generate benchmark fixtures for performance testing
#
# Fixture specifications:
# - bench-small:       50 files,    5K LOC,   flat structure
# - bench-medium:     500 files,   50K LOC,   3-level nesting
# - bench-large:     5000 files,  500K LOC,   5-level nesting
# - bench-deep:      1000 files,   50K LOC,  50+ levels deep
# - bench-large-files: 100 files, ~10MB total, includes 1MB+ files
#
# Usage:
#   ./scripts/gen-fixtures           # Generate all fixtures
#   ./scripts/gen-fixtures --verify  # Verify existing fixtures
#   ./scripts/gen-fixtures --clean   # Remove all fixtures

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
FIXTURES_DIR="$REPO_ROOT/tests/fixtures"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Generate deterministic Rust code for a given seed
# Args: $1 = target lines, $2 = seed string
generate_rust_file() {
    local lines=$1
    local seed=$2
    local safe_seed
    safe_seed=$(echo "$seed" | tr '/' '_' | tr '-' '_')

    cat <<EOF
//! Module $safe_seed
//!
//! Auto-generated benchmark fixture.
//! DO NOT EDIT - regenerate with ./scripts/gen-fixtures

use std::collections::HashMap;

/// A sample struct for benchmarking
#[derive(Debug, Clone, Default)]
pub struct Sample${safe_seed} {
    pub id: u64,
    pub name: String,
    pub data: Vec<u8>,
    pub metadata: HashMap<String, String>,
}

impl Sample${safe_seed} {
    /// Create a new instance
    pub fn new(id: u64, name: impl Into<String>) -> Self {
        Self {
            id,
            name: name.into(),
            data: Vec::new(),
            metadata: HashMap::new(),
        }
    }

    /// Get the ID
    pub fn id(&self) -> u64 {
        self.id
    }

    /// Get the name
    pub fn name(&self) -> &str {
        &self.name
    }

    /// Add data
    pub fn add_data(&mut self, byte: u8) {
        self.data.push(byte);
    }

    /// Set metadata
    pub fn set_meta(&mut self, key: impl Into<String>, value: impl Into<String>) {
        self.metadata.insert(key.into(), value.into());
    }
}

EOF

    # Add filler lines to reach target (header is ~45 lines)
    local header_lines=45
    local remaining=$((lines - header_lines))
    if [[ $remaining -gt 0 ]]; then
        echo "// Additional lines for LOC target"
        for i in $(seq 1 $remaining); do
            echo "const LINE_${i}: &str = \"value_${i}_${safe_seed}\";"
        done
    fi
}

# Generate a large Rust file (for bench-large-files)
# Args: $1 = target size in KB, $2 = seed
generate_large_file() {
    local size_kb=$1
    local seed=$2
    local safe_seed
    safe_seed=$(echo "$seed" | tr '/' '_' | tr '-' '_')

    # ~100 bytes per line average
    local lines=$((size_kb * 10))

    cat <<EOF
//! Large generated file (~${size_kb}KB)
//!
//! Auto-generated benchmark fixture for testing large file handling.
//! DO NOT EDIT - regenerate with ./scripts/gen-fixtures

use std::collections::HashMap;

/// Large struct with many fields
#[derive(Debug, Clone)]
pub struct LargeStruct${safe_seed} {
    pub field_001: String,
    pub field_002: Vec<u8>,
    pub field_003: HashMap<String, String>,
}

impl Default for LargeStruct${safe_seed} {
    fn default() -> Self {
        Self {
            field_001: String::new(),
            field_002: Vec::new(),
            field_003: HashMap::new(),
        }
    }
}

EOF

    # Generate lines with ~80 chars each to reach target size
    local header_lines=30
    local remaining=$((lines - header_lines))
    for i in $(seq 1 $remaining); do
        # ~80 chars per line
        printf 'const DATA_%05d: &str = "%s";\n' "$i" "$(printf 'x%.0s' {1..60})"
    done
}

# Create Cargo.toml for a fixture
# Args: $1 = fixture name
create_cargo_toml() {
    local name=$1
    local safe_name
    safe_name=$(echo "$name" | tr '-' '_')

    cat <<EOF
[package]
name = "$safe_name"
version = "0.0.0"
edition = "2021"
publish = false

# This is a benchmark fixture - not a real crate
# Auto-generated by ./scripts/gen-fixtures
EOF
}

# Create .gitignore for a fixture
create_gitignore() {
    cat <<EOF
# Build artifacts
/target/
/build/

# IDE
.idea/
.vscode/
*.swp
*.swo

# Generated
*.generated
EOF
}

# Generate bench-small: 50 files, ~5K LOC, flat structure
generate_bench_small() {
    local fixture_dir="$FIXTURES_DIR/bench-small"
    echo -e "${YELLOW}Generating bench-small...${NC}"

    rm -rf "$fixture_dir"
    mkdir -p "$fixture_dir/src"
    mkdir -p "$fixture_dir/build"

    create_cargo_toml "bench-small" > "$fixture_dir/Cargo.toml"
    create_gitignore > "$fixture_dir/.gitignore"

    # Create 50 files with ~100 LOC each = 5K LOC total
    for i in $(seq -w 1 50); do
        generate_rust_file 100 "mod_$i" > "$fixture_dir/src/mod_$i.rs"
    done

    # Create lib.rs that declares modules
    {
        echo "//! Benchmark fixture: bench-small"
        echo "//! 50 files, ~5K LOC, flat structure"
        echo ""
        for i in $(seq -w 1 50); do
            echo "pub mod mod_$i;"
        done
    } > "$fixture_dir/src/lib.rs"

    # Add ignored file in build/
    echo "// ignored build artifact" > "$fixture_dir/build/artifact.rs"

    echo -e "${GREEN}Generated bench-small: 50 files${NC}"
}

# Generate bench-medium: 500 files, ~50K LOC, 3-level nesting
generate_bench_medium() {
    local fixture_dir="$FIXTURES_DIR/bench-medium"
    echo -e "${YELLOW}Generating bench-medium...${NC}"

    rm -rf "$fixture_dir"
    mkdir -p "$fixture_dir/src"
    mkdir -p "$fixture_dir/build"

    create_cargo_toml "bench-medium" > "$fixture_dir/Cargo.toml"
    create_gitignore > "$fixture_dir/.gitignore"

    # Create 500 files across 26 directories (a-z) × ~20 files each
    local file_count=0
    for dir in {a..z}; do
        mkdir -p "$fixture_dir/src/$dir"

        # ~20 files per directory (total ~520, close to 500)
        local files_per_dir=20
        if [[ "$dir" > "t" ]]; then
            files_per_dir=17  # Last 6 dirs get fewer files to hit ~500
        fi

        for i in $(seq 1 $files_per_dir); do
            generate_rust_file 100 "${dir}_$i" > "$fixture_dir/src/$dir/mod_$i.rs"
            ((file_count++))
        done

        # Create mod.rs for subdirectory
        {
            echo "//! Module $dir"
            for i in $(seq 1 $files_per_dir); do
                echo "pub mod mod_$i;"
            done
        } > "$fixture_dir/src/$dir/mod.rs"
    done

    # Create lib.rs
    {
        echo "//! Benchmark fixture: bench-medium"
        echo "//! ~500 files, ~50K LOC, 3-level nesting"
        echo ""
        for dir in {a..z}; do
            echo "pub mod $dir;"
        done
    } > "$fixture_dir/src/lib.rs"

    # Add ignored file in build/
    echo "// ignored build artifact" > "$fixture_dir/build/artifact.rs"

    echo -e "${GREEN}Generated bench-medium: $file_count files${NC}"
}

# Generate bench-large: 5000 files, ~500K LOC, 5-level nesting
generate_bench_large() {
    local fixture_dir="$FIXTURES_DIR/bench-large"
    echo -e "${YELLOW}Generating bench-large...${NC}"

    rm -rf "$fixture_dir"
    mkdir -p "$fixture_dir/src"
    mkdir -p "$fixture_dir/build"

    create_cargo_toml "bench-large" > "$fixture_dir/Cargo.toml"
    create_gitignore > "$fixture_dir/.gitignore"

    # Create 5000 files: 26 dirs × 10 subdirs × ~20 files each
    local file_count=0
    for dir1 in {a..z}; do
        for dir2 in {0..9}; do
            mkdir -p "$fixture_dir/src/$dir1/$dir2"

            # ~20 files per leaf directory (26 × 10 × 20 = 5200, close to 5000)
            local files_per_dir=19
            if [[ "$dir1" > "w" ]]; then
                files_per_dir=16  # Reduce for last few dirs
            fi

            for i in $(seq 1 $files_per_dir); do
                generate_rust_file 100 "${dir1}_${dir2}_$i" > "$fixture_dir/src/$dir1/$dir2/mod_$i.rs"
                ((file_count++))
            done

            # Create mod.rs for leaf directory
            {
                echo "//! Module ${dir1}::${dir2}"
                for i in $(seq 1 $files_per_dir); do
                    echo "pub mod mod_$i;"
                done
            } > "$fixture_dir/src/$dir1/$dir2/mod.rs"
        done

        # Create mod.rs for first-level directory
        {
            echo "//! Module $dir1"
            for dir2 in {0..9}; do
                echo "pub mod d$dir2;"  # Prefix with 'd' since modules can't start with digit
            done
        } > "$fixture_dir/src/$dir1/mod.rs"

        # Rename directories to be valid module names
        for dir2 in {0..9}; do
            mv "$fixture_dir/src/$dir1/$dir2" "$fixture_dir/src/$dir1/d$dir2"
        done
    done

    # Create lib.rs
    {
        echo "//! Benchmark fixture: bench-large"
        echo "//! ~5000 files, ~500K LOC, 5-level nesting"
        echo ""
        for dir in {a..z}; do
            echo "pub mod $dir;"
        done
    } > "$fixture_dir/src/lib.rs"

    # Add ignored file in build/
    echo "// ignored build artifact" > "$fixture_dir/build/artifact.rs"

    echo -e "${GREEN}Generated bench-large: $file_count files${NC}"
}

# Generate bench-deep: 1000 files, ~50K LOC, 120+ levels deep
# Also creates marker files for depth limit testing:
# - mid.rs at level 50 (within default 100 limit)
# - deep.rs at level 120 (beyond default 100 limit)
generate_bench_deep() {
    local fixture_dir="$FIXTURES_DIR/bench-deep"
    echo -e "${YELLOW}Generating bench-deep...${NC}"

    rm -rf "$fixture_dir"
    mkdir -p "$fixture_dir/src"
    mkdir -p "$fixture_dir/build"

    create_cargo_toml "bench-deep" > "$fixture_dir/Cargo.toml"
    create_gitignore > "$fixture_dir/.gitignore"

    # Create deep directory structure with files at various levels
    local file_count=0
    local depth=55

    # Build the deep path
    local deep_path="$fixture_dir/src"
    for i in $(seq 1 $depth); do
        deep_path="$deep_path/level_$i"
    done
    mkdir -p "$deep_path"

    # Distribute 1000 files across the depth
    # Put ~20 files at each level (50 levels × 20 files = 1000)
    local current_path="$fixture_dir/src"
    for i in $(seq 1 $depth); do
        current_path="$current_path/level_$i"

        # Create files at this level
        local files_at_level=18
        if [[ $i -le 5 ]]; then
            files_at_level=20  # More files at shallower levels
        fi

        for j in $(seq 1 $files_at_level); do
            generate_rust_file 50 "level_${i}_mod_$j" > "$current_path/mod_$j.rs"
            ((file_count++))
        done

        # Create mod.rs at this level
        {
            echo "//! Level $i module"
            for j in $(seq 1 $files_at_level); do
                echo "pub mod mod_$j;"
            done
            if [[ $i -lt $depth ]]; then
                echo "pub mod level_$((i + 1));"
            fi
        } > "$current_path/mod.rs"
    done

    # Create lib.rs
    {
        echo "//! Benchmark fixture: bench-deep"
        echo "//! ~1000 files, ~50K LOC, 55 levels deep"
        echo ""
        echo "pub mod level_1;"
    } > "$fixture_dir/src/lib.rs"

    # Add ignored file in build/
    echo "// ignored build artifact" > "$fixture_dir/build/artifact.rs"

    # Create marker files for depth limit testing
    # mid.rs at level 50 (within default 100 limit)
    local mid_path="$fixture_dir"
    for i in $(seq 1 50); do
        mid_path="$mid_path/d"
    done
    mkdir -p "$mid_path"
    echo "// Marker file at depth 50 (within default 100 limit)" > "$mid_path/mid.rs"
    ((file_count++))

    # deep.rs at level 120 (beyond default 100 limit)
    local deep_path="$fixture_dir"
    for i in $(seq 1 120); do
        deep_path="$deep_path/d"
    done
    mkdir -p "$deep_path"
    echo "// Marker file at depth 120 (beyond default 100 limit)" > "$deep_path/deep.rs"
    ((file_count++))

    echo -e "${GREEN}Generated bench-deep: $file_count files, $depth source levels + marker files at 50/120${NC}"
}

# Generate bench-large-files: 100 files, ~10MB total, includes 1MB+ files
generate_bench_large_files() {
    local fixture_dir="$FIXTURES_DIR/bench-large-files"
    echo -e "${YELLOW}Generating bench-large-files...${NC}"

    rm -rf "$fixture_dir"
    mkdir -p "$fixture_dir/src"
    mkdir -p "$fixture_dir/build"

    create_cargo_toml "bench-large-files" > "$fixture_dir/Cargo.toml"
    create_gitignore > "$fixture_dir/.gitignore"

    # Generate 5 large files (~1.2MB each to be safely over 1MB threshold)
    for i in $(seq 1 5); do
        echo -e "  Generating large file $i (1.2MB)..."
        generate_large_file 1200 "large_$i" > "$fixture_dir/src/large_$i.rs"
    done

    # Generate 95 medium files (~50KB each = ~5MB more)
    for i in $(seq 1 95); do
        generate_large_file 50 "medium_$i" > "$fixture_dir/src/medium_$i.rs"
    done

    # Create lib.rs
    {
        echo "//! Benchmark fixture: bench-large-files"
        echo "//! 100 files, ~10MB total, 5 files >1MB"
        echo ""
        for i in $(seq 1 5); do
            echo "pub mod large_$i;"
        done
        for i in $(seq 1 95); do
            echo "pub mod medium_$i;"
        done
    } > "$fixture_dir/src/lib.rs"

    # Add ignored file in build/
    echo "// ignored build artifact" > "$fixture_dir/build/artifact.rs"

    echo -e "${GREEN}Generated bench-large-files: 100 files${NC}"
}

# Verify fixtures
verify_fixtures() {
    echo -e "${YELLOW}Verifying fixtures...${NC}"
    local all_ok=true

    # Check bench-small
    local count
    count=$(find "$FIXTURES_DIR/bench-small" -name "*.rs" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$count" -ge 50 ]]; then
        echo -e "  bench-small:       ${GREEN}$count files ${NC}"
    else
        echo -e "  bench-small:       ${RED}$count files (expected ~50)${NC}"
        all_ok=false
    fi

    # Check bench-medium
    count=$(find "$FIXTURES_DIR/bench-medium" -name "*.rs" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$count" -ge 450 ]]; then
        echo -e "  bench-medium:      ${GREEN}$count files ${NC}"
    else
        echo -e "  bench-medium:      ${RED}$count files (expected ~500)${NC}"
        all_ok=false
    fi

    # Check bench-large
    count=$(find "$FIXTURES_DIR/bench-large" -name "*.rs" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$count" -ge 4500 ]]; then
        echo -e "  bench-large:       ${GREEN}$count files ${NC}"
    else
        echo -e "  bench-large:       ${RED}$count files (expected ~5000)${NC}"
        all_ok=false
    fi

    # Check bench-deep
    count=$(find "$FIXTURES_DIR/bench-deep" -name "*.rs" 2>/dev/null | wc -l | tr -d ' ')
    local depth
    depth=$(find "$FIXTURES_DIR/bench-deep" -type d 2>/dev/null | awk -F/ '{print NF}' | sort -n | tail -1)
    if [[ "$count" -ge 900 ]]; then
        echo -e "  bench-deep:        ${GREEN}$count files, $depth levels${NC}"
    else
        echo -e "  bench-deep:        ${RED}$count files (expected ~1000)${NC}"
        all_ok=false
    fi

    # Check bench-large-files
    count=$(find "$FIXTURES_DIR/bench-large-files" -name "*.rs" 2>/dev/null | wc -l | tr -d ' ')
    local large_count
    large_count=$(find "$FIXTURES_DIR/bench-large-files" -name "*.rs" -size +1M 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$count" -ge 95 ]] && [[ "$large_count" -ge 5 ]]; then
        echo -e "  bench-large-files: ${GREEN}$count files, $large_count >1MB${NC}"
    else
        echo -e "  bench-large-files: ${RED}$count files, $large_count >1MB (expected 100, 5)${NC}"
        all_ok=false
    fi

    if $all_ok; then
        echo -e "\n${GREEN}All fixtures verified successfully!${NC}"
    else
        echo -e "\n${RED}Some fixtures need regeneration. Run: ./scripts/gen-fixtures${NC}"
        exit 1
    fi
}

# Clean fixtures
clean_fixtures() {
    echo -e "${YELLOW}Cleaning fixtures...${NC}"
    rm -rf "$FIXTURES_DIR/bench-small"
    rm -rf "$FIXTURES_DIR/bench-medium"
    rm -rf "$FIXTURES_DIR/bench-large"
    rm -rf "$FIXTURES_DIR/bench-deep"
    rm -rf "$FIXTURES_DIR/bench-large-files"
    echo -e "${GREEN}Cleaned all benchmark fixtures${NC}"
}

# Main
main() {
    case "${1:-}" in
        --verify)
            verify_fixtures
            ;;
        --clean)
            clean_fixtures
            ;;
        --help|-h)
            echo "Usage: $0 [--verify|--clean|--help]"
            echo ""
            echo "Options:"
            echo "  (no args)  Generate all benchmark fixtures"
            echo "  --verify   Verify existing fixtures"
            echo "  --clean    Remove all benchmark fixtures"
            echo "  --help     Show this help message"
            ;;
        "")
            mkdir -p "$FIXTURES_DIR"
            generate_bench_small
            generate_bench_medium
            generate_bench_large
            generate_bench_deep
            generate_bench_large_files
            echo ""
            verify_fixtures
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Run '$0 --help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
