name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          # llvm-tools-preview: Required by cargo-llvm-cov for Rust coverage
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      # cargo-llvm-cov: Rust coverage collection for tests/specs/checks/tests/coverage.rs
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov
      # go: Required for tests/specs/checks/tests/runners.rs go_runner_* tests
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
      # bats: Required for tests/specs/checks/tests/runners.rs bats_runner_* tests
      - name: Install bats
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y bats
          else
            brew install bats-core
          fi
        shell: bash
      # node: Required for tests/specs/checks/tests/js_runners.rs vitest tests
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      # Setup JS test fixtures (install npm modules)
      - name: Setup JS fixtures
        run: ./scripts/fixtures/setup-js-fixtures.sh
      - run: cargo test --all

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --all
      - name: Self Check
        run: ./target/debug/quench check --ci

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit
      - run: cargo audit

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          arguments: --all-features
          command: check licenses bans sources

  benchmark:
    name: Benchmark Regression Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release -p quench

      - name: Run regression tests
        run: cargo test --release --bench regression -- --nocapture

      - name: Run dogfood benchmarks
        run: cargo bench --bench dogfood -- --noplot

      - name: Check for regressions
        run: |
          # Compare against baseline thresholds
          BASELINE="reports/benchmark-baseline.json"
          if [ -f "$BASELINE" ]; then
            TARGET_MS=$(jq '.thresholds.warm_acceptable_ms' "$BASELINE")
            echo "Warm run target: <${TARGET_MS}ms"
          fi
